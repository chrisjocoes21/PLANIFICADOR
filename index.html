<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- FIX UX: Evita zoom autom치tico en inputs en iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planificador Docente</title>
    
    <!-- OPTIMIZACI칍N DE CONEXI칍N -->
    <link rel="preconnect" href="https://docs.google.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3C!-- Document background (White) --%3E%3Crect x=%2215%22 y=%2215%22 width=%2270%22 height=%2270%22 rx=%228%22 fill=%22%23FFFFFF%22 stroke=%22%231B4965%22 stroke-width=%223%22/%3E%3C!-- Corner fold for depth --%3E%3Cpath d=%22M85 15 L85 30 L70 15 Z%22 fill=%22%23E0EFFF%22/%3E %3C!-- Planner lines (Medium Teal) --%3E%3Crect x=%2225%22 y=%2230%22 width=%2250%22 height=%225%22 fill=%22%233A9D9D%22 rx=%221%22/%3E%3Crect x=%2225%22 y=%2245%22 width=%2250%22 height=%225%22 fill=%22%233A9D9D%22 rx=%221%22/%3E%3Crect x=%2225%22 y=%2260%22 width=%2230%22 height=%225%22 fill=%22%233A9D9D%22 rx=%221%22/%3E%3C!-- Pencil (Dark Teal) --%3E%3Cg transform=%22rotate(45 75 80)%22%3E%3Crect x=%2265%22 y=%2270%22 width=%2230%22 height=%228%22 rx=%222%22 fill=%22%231B4965%22/%3E%3C!-- Pencil tip --%3E%3Cpolygon points=%2295,74 90,70 90,78%22 fill=%22%234B5563%22/%3E %3C!-- Eraser (Yellow Accent) --%3E%3Crect x=%2263%22 y=%2270%22 width=%224%22 height=%228%22 fill=%22%23FFC857%22/%3E%3C/g%3E%3C/svg%3E">

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Chewy&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- LIBRER칈AS PARA WORD (Frontend) -->
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.49.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- FIX FUNCIONAL: JSON5 para parsing robusto -->
    <script src="https://unpkg.com/json5@2/dist/index.min.js"></script>

    <!-- LIBRER칈AS PARA LECTURA DE DOCUMENTOS (NUEVO) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuraci칩n Worker PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        montserrat: ['Montserrat', 'sans-serif'],
                        chewy: ['Chewy', 'cursive']
                    },
                    colors: {
                        montessori: {
                            blue: '#1B4965',     // Primario (Dark Teal)
                            teal: '#3A9D9D',     // Secundario (Medium Teal)
                            red: '#e74c3c',      // Peligro (Red)
                            yellow: '#FFC857',   // Acento Amarillo
                            gray: '#F3F4F6',
                            lightBlue: '#E0EFFF' // Fondo Claro
                        }
                    },
                    boxShadow: {
                        'card-hover': '0 15px 30px -5px rgba(0, 0, 0, 0.08), 0 10px 12px -6px rgba(0, 0, 0, 0.02)',
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.03)'
                    },
                    animation: {
                        'diagonal-shift': 'diagonalShift 3s ease-in-out infinite alternate',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'teal-yellow-cycle': 'tealYellowCycle 3s infinite cubic-bezier(0.4, 0, 0.2, 1)', 
                    },
                    keyframes: {
                        diagonalShift: {
                            '0%': { 'background-position': '0% 0%' },
                            '100%': { 'background-position': '100% 100%' },
                        },
                        tealYellowCycle: {
                            '0%, 100%': { color: '#1B4965' }, // Dark Teal
                            '50%': { color: '#FFC857' }       // Yellow
                        },
                        successFeedback: {
                            '0%': { transform: 'scale(1)', opacity: 1 },
                            '50%': { transform: 'scale(1.05)', opacity: 0.8 },
                            '100%': { transform: 'scale(1)', opacity: 1 },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* CONTROL DE LAYOUT PRINCIPAL */
        body { 
            background-color: #f8fafc; 
            height: 100vh; 
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- SCROLL INVISIBLE GLOBAL --- */
        *::-webkit-scrollbar {
            display: none;
            width: 0 !important;
            height: 0 !important;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
            touch-action: manipulation;
        }

        .custom-scroll { 
            overflow-y: auto;
        }

        /* --- FONDO ANIMADO --- */
        .particles-container {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .grade-particle {
            position: absolute;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900; 
            opacity: 0;
            user-select: none;
            text-shadow: 0 2px 4px rgba(255,255,255,0.5); 
        }

        .grade-particle.primary-teal { color: rgba(27, 73, 101, 0.25); }
        .grade-particle.secondary-teal { color: rgba(58, 157, 157, 0.25); }

        .grade-particle.background {
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(110vh) scale(0.8) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10vh) scale(1.1) rotate(var(--rotation)); opacity: 0; }
        }

        .grid-overlay {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(27, 73, 101, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(27, 73, 101, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
        }

        .animated-diagonal-background {
            background: repeating-linear-gradient(
                45deg, 
                #E0EFFF 0%, 
                #E0EFFF 40%, 
                #E0EFFF 60%, 
                #E0EFFF 100%
            );
            background-size: 200vw 200vh;
            animation: diagonalShift 3s ease-in-out infinite alternate; 
            position: absolute; 
            inset: 0;
            z-index: 0;
            will-change: background-position, transform; 
        }

        /* Estilos del Editor Manual */
        .plan-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .plan-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .day-header {
            color: #1B4965;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1rem;
            border-bottom: 2px solid #E0EFFF;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .section-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 0.3rem;
            letter-spacing: 0.05em;
            margin-top: 1rem;
        }
        .section-label:first-of-type { margin-top: 0; }

        .editable-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 16px; 
            line-height: 1.5;
            color: #334155;
            background-color: #f8fafc;
            transition: all 0.2s;
            resize: none;
            outline: none;
        }

        @media (min-width: 768px) {
            .editable-field { font-size: 0.875rem; }
        }
        
        .editable-field:focus {
            background-color: #ffffff;
            border-color: #1B4965;
            box-shadow: 0 0 0 3px rgba(27, 73, 101, 0.1);
        }
        
        .field-topic { height: 3rem; font-weight: 600; }
        .field-materials { height: 4rem; }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* --- ANIMACIONES GENERALES --- */
        
        @keyframes colorPulseFooter {
            0% { color: #4B5563; }
            33% { color: #FFC857; }
            66% { color: #1B4965; }
            100% { color: #4B5563; }
        }
        
        .animate-pulse-color { 
            animation: colorPulseFooter 4s ease-in-out infinite !important; 
        }
        
        .fade-out { animation: fadeOut 0.4s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.99); pointer-events: none; } }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top: 3px solid #ffffff;
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #btn-login { min-height: 48px; }
        #btn-text { transition: opacity 0.3s; }
        #btn-text.hidden-text { opacity: 0; }

        @keyframes tealYellowCycle {
            0%, 100% { color: #1B4965; }
            50% { color: #FFC857; }
        }
        .animate-teal-yellow-cycle { animation: tealYellowCycle 3s infinite cubic-bezier(0.4, 0, 0.2, 1); }

        .animate-success-feedback {
            animation: successFeedback 0.3s ease-in-out;
        }

        /* CUSTOM SELECT STYLES */
        .custom-select-container { position: relative; width: 100%; }
        .custom-select-trigger { 
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 0.625rem 1rem; 
            background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem;
            font-size: 0.875rem; font-weight: 500; color: #1f2937;
            cursor: pointer; transition: all 0.2s;
        }
        .custom-select-trigger:hover { border-color: #1B4965; }
        
        .custom-dropdown-list {
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0;
            background-color: white; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem;
            margin-top: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 60; 
            max-height: 200px; 
            overflow-y: auto;
        }
        
        .custom-dropdown-list button {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem; 
            text-align: left;
            font-size: 0.875rem; 
            color: #374151; 
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        
        .custom-dropdown-list button:hover { 
            background-color: #E0EFFF; 
            color: #1B4965; 
        }

        .day-btn.active {
            background-color: #1B4965;
            color: white; 
            border-color: #1B4965;
            box-shadow: 0 2px 5px rgba(27, 73, 101, 0.2);
        }

        /* Estilos deshabilitados */
        .disabled-btn {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

    </style>
</head>
<body class="text-slate-800 font-sans antialiased">

    <!-- PRELOADER -->
    <div id="initial-loader" class="fixed inset-0 z-[300] flex items-center justify-center bg-montessori-lightBlue transition-all duration-700">
        <div class="animated-diagonal-background animate-diagonal-shift"></div>
        <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        <div class="relative z-20 flex flex-col items-center justify-center">
            <h1 class="text-5xl md:text-7xl font-bold font-montserrat animate-teal-yellow-cycle drop-shadow-sm text-center leading-tight">Cargando...</h1>
        </div>
    </div>
    
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-montessori-lightBlue overflow-hidden transition-all duration-700">
        <div class="animated-diagonal-background animate-diagonal-shift"></div>
        <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        
        <div id="login-card" class="relative z-20 w-full max-w-3xl mx-4 transition-all duration-700">
            <div class="bg-white/90 backdrop-blur-xl border border-white/50 rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[380px]">
                <div class="w-full md:w-5/12 bg-montessori-blue flex flex-col items-center justify-center p-6 border-b md:border-b-0 md:border-r border-montessori-blue gap-4">
                    <h1 class="text-3xl md:text-5xl font-extrabold text-white font-montserrat text-center leading-snug tracking-tight">
                        Planificador Docente
                    </h1>
                    <p class="text-sm text-white/90 font-medium text-center mt-2">Herramienta de Productividad Educativa</p>
                </div>
                <div class="w-full md:w-7/12 p-6 md:p-8 flex flex-col justify-center">
                    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Credenciales de Acceso</label>
                            <div class="space-y-3">
                                <div class="relative group z-20">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-600 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </div>
                                    <input type="text" id="username" required class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-white border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-500 text-base md:text-sm placeholder-gray-600" placeholder="Usuario">
                                </div>
                                <div class="relative group z-20">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-600 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    </div>
                                    <input type="password" id="password" required class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-white border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-500 text-base md:text-sm placeholder-gray-600" placeholder="Contrase침a">
                                </div>
                            </div>
                        </div>
                        <div id="login-status-container" class="min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border border-transparent text-center px-2 py-1 bg-gray-50">
                             <span id="login-status-text" class="text-xs font-medium text-gray-600">Ingrese sus credenciales para continuar</span>
                        </div>
                        <button type="submit" id="btn-login" class="relative w-full bg-montessori-blue text-white font-bold text-sm py-3 rounded-lg shadow-lg shadow-montessori-blue/30 hover:bg-[#123145] hover:shadow-montessori-blue/50 hover:scale-[1.01] active:scale-[0.99] transition-all duration-300 flex justify-center items-center">
                            <span id="btn-text">Iniciar Sesi칩n</span>
                            <div id="btn-loader" class="loader hidden absolute w-5 h-5 border-2"></div>
                        </button>
                    </form>
                    <div class="mt-4 text-center">
                        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=gestion.educativa.pinceladas@gmail.com" target="_blank" class="text-[10px] text-gray-600 hover:text-montessori-blue transition-colors font-medium inline-flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            Soporte T칠cnico
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE ACCESO DENEGADO -->
    <div id="access-denied-modal" class="hidden fixed inset-0 z-[210] flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 border border-gray-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-50 mb-4 animate-pulse">
                    <svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                </div>
                <h3 class="text-xl leading-6 font-bold text-gray-900 mb-2">Acceso Restringido</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-600 mb-6">Su perfil de usuario no cuenta con los permisos necesarios para utilizar la herramienta de <strong>Planificaci칩n Docente</strong>.</p>
                    <p class="text-xs text-montessori-blue font-bold bg-montessori-lightBlue p-3 rounded-lg border border-montessori-lightBlue/50">Para solicitar acceso a esta funcionalidad espec칤fica, por favor comun칤quese con Christopher Cordero.</p>
                </div>
                <div class="mt-6">
                    <button type="button" onclick="logout()" class="w-full inline-flex justify-center items-center rounded-xl border border-transparent shadow-md px-4 py-3 bg-gray-800 text-base font-bold text-white hover:bg-gray-700 focus:outline-none transition-all transform hover:-translate-y-0.5">Entendido, Cerrar Sesi칩n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CUPO EXCEDIDO (EST츼TICO Y SIN ANIMACI칍N) -->
    <div id="quota-exceeded-modal" class="hidden fixed inset-0 z-[220] flex items-center justify-center bg-black/60 backdrop-blur-md">
        <!-- Eliminadas transiciones y animaciones para hacerlo est치tico -->
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4 border-2 border-red-100">
            <div class="text-center">
                <!-- Icono est치tico (sin animate-bounce) -->
                <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-red-100 mb-6">
                    <svg class="h-10 w-10 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-black text-gray-800 mb-2">춰L칤mite Mensual Alcanzado!</h3>
                <p class="text-sm text-gray-500 font-medium mb-6">Has agotado tus generaciones de este mes.</p>
                
                <div class="bg-red-50 p-4 rounded-xl border border-red-100 mb-6 text-left">
                    <p class="text-xs text-red-800 font-semibold mb-2">游뛂 Restricciones Activadas:</p>
                    <ul class="text-xs text-red-700 list-disc list-inside space-y-1">
                        <li>No puedes generar nuevos planes.</li>
                        <li>No puedes modificar planes existentes.</li>
                        <li>El acceso se restablecer치 el: <strong id="reset-date-display" class="text-red-900"></strong>.</li>
                    </ul>
                </div>

                <!-- Bot칩n que ejecuta logout inmediatamente -->
                <button type="button" onclick="logout()" class="w-full inline-flex justify-center items-center rounded-xl shadow-lg px-4 py-3 bg-gray-800 text-white font-bold hover:bg-gray-900 transition-colors">
                    Entendido
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL INSTRUCCIONES MEJORADO -->
    <div id="instructions-modal" class="hidden fixed inset-0 z-[250] flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 border border-gray-100 flex flex-col h-[85vh] transition-all transform duration-300">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100 flex-shrink-0">
                <h3 class="text-lg font-bold text-montessori-blue font-montserrat flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Recursos & Instrucciones
                </h3>
                <button onclick="toggleInstructionsModal()" class="text-gray-400 hover:text-montessori-red transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 flex flex-col md:flex-row gap-6 overflow-hidden">
                <!-- Columna Izquierda: Instrucciones -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Instrucciones Adicionales</label>
                    <textarea id="instructions-input" class="w-full flex-1 p-4 rounded-xl bg-gray-50 border border-gray-200 text-sm focus:border-montessori-blue focus:ring-2 focus:ring-montessori-lightBlue outline-none resize-none transition-all" placeholder="Ej: Enfocarse en ejercicios pr치cticos..."></textarea>
                </div>

                <!-- Columna Derecha: Archivos -->
                <div class="flex-1 flex flex-col overflow-hidden border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-6">
                    <div class="flex justify-between items-end mb-2 flex-shrink-0">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Archivos (Img, PDF, Docx)</label>
                        <span id="img-count" class="text-[10px] text-gray-400 font-medium">0/12</span>
                    </div>
                    
                    <input type="file" id="image-upload" accept="image/*,.pdf,.docx" multiple class="hidden" onchange="handleFileUpload(event)">
                    
                    <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-gray-50 transition-colors cursor-pointer flex-shrink-0" onclick="document.getElementById('image-upload').click()">
                        <div class="text-gray-400 flex flex-col items-center gap-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="text-xs font-medium">Adjuntar Archivos</span>
                        </div>
                    </div>

                    <div id="images-grid" class="hidden grid grid-cols-2 lg:grid-cols-3 gap-2 mt-3 overflow-y-auto custom-scroll pr-1"></div>
                    <div id="docs-list" class="mt-2 space-y-1 overflow-y-auto max-h-[100px] custom-scroll"></div>
                </div>
            </div>

            <div class="mt-4 flex justify-end gap-3 pt-3 border-t border-gray-100 flex-shrink-0">
                <button onclick="toggleInstructionsModal()" class="px-4 py-2 text-sm text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button onclick="saveInstructions()" class="px-6 py-2 bg-montessori-blue text-white text-sm font-bold rounded-lg hover:bg-[#123145] transition-colors shadow-lg shadow-montessori-blue/30">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE COMENTARIOS / MODIFICACI칍N (NUEVO) -->
    <div id="modification-modal" class="hidden fixed inset-0 z-[260] flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 border border-gray-100 flex flex-col h-[60vh] md:h-[50vh] transition-all transform duration-300">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100 flex-shrink-0">
                <h3 class="text-lg font-bold text-montessori-blue font-montserrat flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    Modificar Plan Actual
                </h3>
                <button onclick="toggleModificationModal()" class="text-gray-400 hover:text-montessori-red transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 flex flex-col gap-2">
                <p class="text-xs text-gray-500 font-medium">Describe qu칠 cambios quieres hacer al plan visible actualmente (ej: "Cambia la actividad del martes por algo m치s l칰dico"). <span class="text-montessori-red font-bold">*Consume 1 uso diario.</span></p>
                <textarea id="modification-input" class="w-full flex-1 p-4 rounded-xl bg-gray-50 border border-gray-200 text-sm focus:border-montessori-blue focus:ring-2 focus:ring-montessori-lightBlue outline-none resize-none transition-all" placeholder="Solicita cambios espec칤ficos..."></textarea>
            </div>

            <div class="mt-4 flex justify-end gap-3 pt-3 border-t border-gray-100 flex-shrink-0">
                <button onclick="toggleModificationModal()" class="px-4 py-2 text-sm text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button onclick="applyModification()" class="px-6 py-2 bg-montessori-blue text-white text-sm font-bold rounded-lg hover:bg-[#123145] transition-colors shadow-lg shadow-montessori-blue/30">Aplicar Cambios</button>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-content" class="hidden flex flex-col h-screen w-full relative z-0 opacity-0 transition-opacity duration-1000 overflow-hidden">
        
        <!-- Fondo -->
        <div class="fixed inset-0 z-0">
            <div class="animated-diagonal-background"></div>
            <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        </div>

        <!-- HEADER -->
        <header class="bg-white/90 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-50 h-16 flex-shrink-0 w-full shadow-sm">
            <div class="w-full px-6 h-full flex justify-between items-center">
                <div class="flex items-center cursor-pointer" onclick="location.reload()">
                     <h1 class="text-lg font-bold text-montessori-blue font-montserrat">Planificador</h1>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="flex flex-col items-center mr-2">
                         <div class="flex items-center gap-1">
                             <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest leading-tight">Hola,</span>
                             <span id="user-name-display" class="text-xs font-black text-montessori-blue leading-tight max-w-[150px] truncate text-right">Usuario</span>
                         </div>
                         <div class="bg-montessori-lightBlue px-3 py-1 rounded-lg mt-1 border border-montessori-lightBlue/50 flex items-center justify-center gap-2 h-6" id="quota-badge">
                             <span class="text-[9px] font-bold text-slate-500 uppercase leading-none">Usos mes:</span>
                             <span id="usage-counter" class="text-xs font-black text-montessori-blue leading-none pt-[1px]">...</span>
                         </div>
                    </div>
                    <button onclick="logout()" class="p-2 text-montessori-red/70 hover:text-montessori-red hover:bg-red-50 rounded-full transition-colors" title="Cerrar Sesi칩n">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-1 w-full relative z-10 overflow-hidden flex flex-col md:flex-row p-4 md:p-6 gap-6 min-h-0">
            
            <!-- PANEL IZQUIERDO: CONFIGURACI칍N -->
            <div class="w-full md:w-1/4 flex flex-col gap-4 overflow-y-auto custom-scroll pr-1 pb-20 md:pb-0 h-full flex-shrink-0">
                <div class="bg-white/95 backdrop-blur rounded-2xl p-6 border border-white shadow-soft hover:shadow-card-hover transition-all duration-300 flex flex-col h-full overflow-y-auto custom-scroll">
                    <!-- HEADER COMPACTO -->
                    <div class="flex items-center gap-2 mb-4 pb-2 border-b border-gray-100 pb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-montessori-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                        <h2 class="text-sm font-bold text-slate-800 font-montserrat">Datos de Clase</h2>
                    </div>

                    <form id="plannerForm" class="space-y-3 flex-1 flex flex-col" onsubmit="generatePlan(event)">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Asignatura</label>
                            <input type="text" id="subject" placeholder="Ingrese la Asignatura" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue text-base md:text-sm font-medium">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Grupo</label>
                            <input type="text" id="groupDetails" placeholder="Ej. 3ro Primaria" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue text-base md:text-sm font-medium">
                        </div>

                        <!-- SELECT MODELO PEDAG칍GICO (ORDENADO Y A칌ADIDO PROYECTOS ARTICULADOS) -->
                        <div class="relative custom-select-container">
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Modelo Pedag칩gico</label>
                            <div id="style-dropdown-btn" class="custom-select-trigger" onclick="toggleDropdown('style')">
                                <span id="selected-style-text" class="text-gray-500 font-normal">Seleccione Modelo...</span>
                                <svg class="h-4 w-4 text-gray-600 transform transition-transform duration-200" id="style-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            </div>
                            <div id="style-dropdown-list" class="custom-dropdown-list hidden">
                                <!-- ORDENADO POR LONGITUD DE NOMBRE -->
                                <button type="button" onclick="selectDropdownValue('style', 'Montessori')">Montessori</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Tradicional')">Tradicional</button>
                                <button type="button" onclick="selectDropdownValue('style', 'L칤der en M칤')">L칤der en M칤</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Gamificaci칩n')">Gamificaci칩n</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Aula Invertida')">Aula Invertida</button>
                                <button type="button" onclick="selectDropdownValue('style', 'ABP (Proyectos)')">ABP (Proyectos)</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Adecuaci칩n Curricular')">Adecuaci칩n Curricular</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Aprendizaje Cooperativo')">Aprendizaje Cooperativo</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Ense침anza por Competencias')">Ense침anza por Competencias</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Proyectos con Articulaci칩n de 츼reas')">Proyectos con Articulaci칩n de 츼reas</button>
                            </div>
                            <input type="hidden" id="teachingStyle" value="">
                        </div>
                        
                        <!-- EXPORTAR A WORD -->
                        <div class="border-t border-gray-100 pt-3 mt-1">
                            <label class="block text-xs font-bold text-montessori-blue uppercase tracking-wider mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Exportar a Word
                            </label>
                            <div class="relative">
                                <input type="file" id="template-upload" accept=".docx" class="hidden" onchange="handleTemplateSelect(event)">
                                <label for="template-upload" class="flex items-center justify-between w-full px-3 py-2 bg-montessori-lightBlue border border-montessori-lightBlue/50 rounded-lg cursor-pointer hover:bg-montessori-lightBlue/70 transition-colors">
                                    <span id="template-name" class="text-xs text-montessori-blue font-medium truncate max-w-[180px]">Cargar Plantilla (.docx)</span>
                                    <svg class="w-4 h-4 text-montessori-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                </label>
                            </div>
                            <p class="text-[9px] text-gray-400 mt-1 leading-tight">Usa etiquetas como {tema_lunes} en tu Word.</p>
                        </div>

                        <!-- SELECTOR DE D칈AS -->
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Clases</label>
                            <div class="grid grid-cols-5 gap-2">
                                <button type="button" onclick="selectDays(1)" id="day-1" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600">1</button>
                                <button type="button" onclick="selectDays(2)" id="day-2" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600">2</button>
                                <button type="button" onclick="selectDays(3)" id="day-3" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600">3</button>
                                <button type="button" onclick="selectDays(4)" id="day-4" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600">4</button>
                                <button type="button" onclick="selectDays(5)" id="day-5" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600 active">5</button>
                            </div>
                            <input type="hidden" id="selectedDays" value="5">
                        </div>

                        <!-- TEMAS -->
                        <div class="flex flex-col min-h-0">
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Temas</label>
                            <textarea id="topics" class="w-full h-12 px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-300 text-base md:text-sm font-medium resize-none" placeholder="Describa los temas..."></textarea>
                        </div>
                        
                        <button type="button" id="btn-instructions" onclick="toggleInstructionsModal()" class="w-full py-2.5 px-3 rounded-lg bg-gray-50 border border-dashed border-gray-300 text-gray-600 hover:text-montessori-blue hover:border-montessori-blue hover:bg-montessori-lightBlue transition-all duration-300 flex items-center justify-center gap-2 group">
                            <span class="text-xs font-bold truncate" id="btn-instructions-text">Recursos (Img/PDF/Doc)</span>
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        </button>
                        <input type="hidden" id="customInstructions" value="">

                        <button type="submit" id="btn-generate" class="group relative w-full bg-montessori-blue hover:bg-[#123145] text-white font-bold py-3.5 rounded-xl shadow-lg shadow-montessori-blue/30 transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-2 overflow-hidden mt-4">
                            <span class="relative z-10 flex items-center gap-2">GENERAR PLAN</span>
                            <div class="absolute inset-0 h-full w-full scale-0 rounded-2xl transition-all duration-300 group-hover:scale-100 group-hover:bg-white/10"></div>
                        </button>
                    </form>
                </div>
            </div>

            <!-- PANEL DERECHO: RESULTADOS (EDITOR MANUAL) -->
            <div class="w-full md:w-3/4 h-full flex flex-col relative min-h-0">
                
                <div id="result-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 bg-white/50 backdrop-blur-sm border-2 border-dashed border-gray-300 rounded-2xl">
                    <div class="w-20 h-20 bg-montessori-lightBlue rounded-full flex items-center justify-center mb-4 animate-pulse-slow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-montessori-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 font-montserrat mb-2">Editor de Planificaci칩n</h3>
                    <p class="text-gray-500 text-sm max-w-sm">Genera un plan con el sistema, edita el contenido tarjeta por tarjeta y exp칩rtalo a tu Word personalizado.</p>
                </div>

                <div id="loader" class="hidden absolute inset-0 z-20 flex items-center justify-center bg-white/90 backdrop-blur-sm rounded-2xl transition-all duration-300">
                    <div class="flex flex-col items-center">
                        <div class="relative w-20 h-20 mb-6">
                            <div class="absolute inset-0 rounded-full border-4 border-gray-100"></div>
                            <div class="absolute inset-0 rounded-full border-4 border-montessori-teal border-t-transparent animate-spin"></div>
                            <div class="absolute inset-3 rounded-full border-4 border-montessori-blue border-t-transparent animate-spin" style="animation-direction: reverse; animation-duration: 2s;"></div>
                        </div>
                        <div class="text-center space-y-2">
                            <h3 class="text-lg font-bold text-montessori-blue font-montserrat animate-pulse">Analizando Recursos...</h3>
                            <p class="text-xs text-gray-500 font-medium">Leyendo documentos y generando actividades...</p>
                        </div>
                    </div>
                </div>

                <!-- Contenedor de Resultados con Editor -->
                <div id="result-content" class="hidden h-full flex-col bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 relative z-10 transition-all duration-500 transform translate-y-4 opacity-0 flex-1">
                    
                    <div class="flex justify-between items-center px-4 py-2 bg-gray-50 border-b border-gray-200 flex-shrink-0 h-14">
                        <div class="flex items-center gap-2">
                             <div class="flex flex-col">
                                <span class="text-sm font-bold text-gray-700">Editor de Contenido</span>
                                <span class="text-[10px] text-gray-500">Los cambios se guardar치n al descargar</span>
                             </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <!-- BOT칍N DE MODIFICACI칍N (NUEVO) -->
                            <button id="btn-modify" onclick="toggleModificationModal()" class="hidden flex items-center gap-2 px-3 py-1.5 bg-montessori-yellow text-slate-800 rounded-lg hover:bg-yellow-400 shadow-md transition-all font-bold text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                MODIFICAR
                            </button>
                            <button id="btn-download-word" onclick="downloadWord()" class="hidden flex items-center gap-2 px-4 py-1.5 bg-montessori-teal text-white rounded-lg hover:bg-[#288B8B] shadow-md transition-all font-bold text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                DESCARGAR WORD
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scroll p-6 bg-gray-50/50" id="editor-container">
                        <!-- AQU칈 SE INYECTAR츼N LAS TARJETAS (JS) -->
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="bg-white/90 backdrop-blur-sm border-t border-gray-200 py-4 mt-auto flex-shrink-0 w-full z-10">
            <div class="text-center text-[10px] sm:text-xs text-gray-600">
                <a href="https://chrisjocoes21.github.io/PORTAFOLIO/" target="_blank" class="animate-pulse-color font-medium transition-colors hover:text-montessori-blue hover:underline" title="Visitar Portafolio">
                    춸 2025 Planificador Acad칠mico - Desarrollado por Didac-Click Group.
                </a>
            </div>
        </footer>
    </div>

    <div class="h-4"></div>
    <div id="toast"></div>

    <script>
        // CONFIGURACI칍N ARQUITECTURA H칈BRIDA
        const API_AUTH_URL = "https://script.google.com/macros/s/AKfycbwnNusWP5LlxipynwTszW7bz70GNZa4n3RfEm-8tsM7nFktVeNvXATqz8HddKY_2YK9/exec";
        const API_GEN_URL = "https://script.google.com/macros/s/AKfycbyYTp9lY07wCjxtwMrFZth_78nJm02gUyTK1V72Ngab9VHbChYAzzteBEUy4VzOZCcGWw/exec";
        
        let selectedDays = 5;
        let currentUser = null;
        let userQuota = { remaining: 0, total: 0 };
        let attachedImages = [];
        let attachedDocsText = ""; 
        const MAX_IMAGES = 12; // L칤mite aumentado
        let currentPlanData = null;
        let quotaPollInterval = null;

        // --- PART칈CULAS DEL FONDO ---
        const symbols = ['Inicio', 'Desarrollo', 'Cierre', 'Obj.', 'Meta', 'Tiempo', 'Recursos', 'Eval.', 'Actividad', 'Plan', 'Clase'];

        function initAllParticles() {
            const containers = document.querySelectorAll('.particles-container');
            containers.forEach(container => {
                container.innerHTML = '<div class="grid-overlay"></div>';
                createParticlesForContainer(container);
            });
        }

        function createParticlesForContainer(container) {
            const particleCount = 18; 
            for (let i = 0; i < particleCount; i++) {
                const span = document.createElement('span');
                span.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                span.classList.add('grade-particle');
                if (Math.random() > 0.5) span.classList.add('primary-teal');
                else span.classList.add('secondary-teal');
                const rotation = Math.floor(Math.random() * 40 - 20);
                span.style.setProperty('--rotation', `${rotation}deg`);
                span.classList.add('background');
                const left = Math.random() * 100;
                const duration = 15 + Math.random() * 20; 
                const delay = Math.random() * -30; 
                const size = 0.8 + Math.random() * 1.2; 
                span.style.left = `${left}%`;
                span.style.animationDuration = `${duration}s`;
                span.style.animationDelay = `${delay}s`;
                span.style.fontSize = `${size}rem`;
                container.appendChild(span);
            }
        }
        
        // --- SISTEMA DE LOGIN Y SESI칍N ---

        window.onload = function() {
            initAllParticles();
            checkSession();
        };

        function checkSession() {
            const session = sessionStorage.getItem('pinceladas_session');
            const loader = document.getElementById('initial-loader');

            if (session) {
                const data = JSON.parse(session);
                loginUserSuccess(data.name, data.usernameUnique, true);
            } else {
                setTimeout(() => {
                    loader.classList.add('opacity-0');
                    setTimeout(() => loader.classList.add('hidden'), 700);
                }, 1000);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('btn-loader');
            const statusBox = document.getElementById('login-status-container');
            const statusText = document.getElementById('login-status-text');

            btnText.classList.add('hidden-text'); 
            loader.classList.remove('hidden');
            btn.disabled = true;
            
            statusBox.className = "min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border px-2 py-1 bg-montessori-lightBlue border-montessori-lightBlue/50";
            statusText.className = "text-xs font-bold text-montessori-blue";
            statusText.innerText = "Verificando credenciales...";

            try {
                const response = await fetch(`${API_AUTH_URL}?action=login&username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`);
                const data = await response.json();

                if (data.success) {
                    statusText.innerText = "Verificando privilegios de acceso...";
                    const quotaResponse = await fetch(`${API_AUTH_URL}?action=checkPlannerQuota&username=${encodeURIComponent(data.usernameUnique)}`);
                    const quotaData = await quotaResponse.json();

                    if (quotaData.success) {
                        if (quotaData.restricted) {
                            showAccessDeniedModal();
                            btnText.classList.remove('hidden-text');
                            loader.classList.add('hidden');
                            btn.disabled = false;
                        } else {
                            const sessionData = {
                                name: data.name,
                                usernameUnique: data.usernameUnique,
                                loginTime: new Date().getTime()
                            };
                            sessionStorage.setItem('pinceladas_session', JSON.stringify(sessionData));
                            userQuota.remaining = quotaData.remaining;
                            userQuota.total = quotaData.limit;
                            loginUserSuccess(data.name, data.usernameUnique, false);
                        }
                    } else {
                         throw new Error("Error al verificar cuota.");
                    }
                } else {
                    throw new Error("Credenciales incorrectas");
                }
            } catch (error) {
                console.error(error);
                statusBox.className = "min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border px-2 py-1 bg-red-50 border-red-200";
                statusText.className = "text-xs font-bold text-red-600";
                statusText.innerText = error.message.includes("Credenciales") ? "Usuario o contrase침a incorrectos" : "Error de conexi칩n";
                btnText.classList.remove('hidden-text');
                loader.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function showAccessDeniedModal() {
            const modal = document.getElementById('access-denied-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0', 'scale-95');
                modal.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        // --- L칍GICA MODAL EST츼TICO DE CUPO ---
        function showQuotaExceededModal() {
            const modal = document.getElementById('quota-exceeded-modal');
            if(modal.classList.contains('hidden')) {
                // Calcular fecha: 1 del pr칩ximo mes
                const now = new Date();
                const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('reset-date-display').innerText = nextMonth.toLocaleDateString('es-ES', options);

                modal.classList.remove('hidden');
                
                // Bloqueo visual de botones
                const btnGen = document.getElementById('btn-generate');
                const btnMod = document.getElementById('btn-modify');
                if(btnGen) btnGen.classList.add('disabled-btn');
                if(btnMod) btnMod.classList.add('disabled-btn');
            }
        }

        function loginUserSuccess(name, usernameUnique, isAutoLogin) {
            currentUser = usernameUnique;
            document.getElementById('user-name-display').innerText = name; 
            const loginScreen = document.getElementById('login-screen');
            const loader = document.getElementById('initial-loader');
            const appContent = document.getElementById('app-content');

            loginScreen.classList.add('fade-out');
            setTimeout(() => loginScreen.classList.add('hidden'), 500);
            
            if(!isAutoLogin) {
                 loader.classList.add('hidden');
            } else {
                refreshQuota(usernameUnique);
                loader.classList.add('opacity-0');
                setTimeout(() => loader.classList.add('hidden'), 700);
            }

            // CRITICAL CHECK: Si entra con 0 cupo, bloquear de inmediato
            if (userQuota.remaining <= 0 && userQuota.total > 0) {
                 showQuotaExceededModal();
            }

            appContent.classList.remove('hidden');
            setTimeout(() => {
                appContent.classList.remove('opacity-0');
                updateQuotaDisplay();
                initDropdowns(); 
                selectDays(selectedDays); 
            }, 100);

            // Iniciar Polling de Cuota (Cada 30 segs)
            if (quotaPollInterval) clearInterval(quotaPollInterval);
            quotaPollInterval = setInterval(() => {
                if(currentUser) refreshQuota(currentUser);
            }, 30000); 
        }

        function logout() {
            sessionStorage.removeItem('pinceladas_session');
            if (quotaPollInterval) clearInterval(quotaPollInterval);
            location.reload();
        }

        async function refreshQuota(username) {
            try {
                const response = await fetch(`${API_AUTH_URL}?action=checkPlannerQuota&username=${encodeURIComponent(username)}`);
                const data = await response.json();
                if(data.success) {
                    if (data.restricted) {
                        // Si se restringe mientras usa (polling), bloquear y mostrar modal para logout
                        userQuota.remaining = 0;
                        checkQuotaLimits(); 
                    } else {
                        userQuota.remaining = data.remaining;
                        userQuota.total = data.limit;
                        updateQuotaDisplay();
                        checkQuotaLimits(); 
                    }
                }
            } catch(e) { console.error("Error refrescando cuota", e); }
        }

        function updateQuotaDisplay() {
            const counter = document.getElementById('usage-counter');
            if(userQuota.total > 0) {
                counter.innerText = `${userQuota.remaining} / ${userQuota.total}`;
                if(userQuota.remaining <= 0) {
                    counter.className = "text-xs font-black text-red-500";
                } else {
                    counter.className = "text-xs font-black text-montessori-blue leading-none pt-[1px]";
                }
            } else {
                counter.innerText = "...";
            }
        }

        function checkQuotaLimits() {
            const btnGen = document.getElementById('btn-generate');
            const btnMod = document.getElementById('btn-modify');

            if (userQuota.remaining <= 0) {
                if(btnGen) {
                    btnGen.disabled = true;
                    btnGen.classList.add('disabled-btn');
                    btnGen.innerHTML = `<span class="relative z-10 flex items-center gap-2">L칈MITE ALCANZADO</span>`;
                }
                if(btnMod) {
                    btnMod.disabled = true;
                    btnMod.classList.add('disabled-btn');
                }
                showQuotaExceededModal(); // Mostrar modal est치tico
            } else {
                // Restaurar estado si se recarga cupo
                if(btnGen && btnGen.disabled) {
                    btnGen.disabled = false;
                    btnGen.classList.remove('disabled-btn');
                    btnGen.innerHTML = `<span class="relative z-10 flex items-center gap-2">GENERAR PLAN</span><div class="absolute inset-0 h-full w-full scale-0 rounded-2xl transition-all duration-300 group-hover:scale-100 group-hover:bg-white/10"></div>`;
                }
                if(btnMod && btnMod.disabled) {
                    btnMod.disabled = false;
                    btnMod.classList.remove('disabled-btn');
                }
                // No ocultamos modal autom치ticamente si ya sali칩 para forzar el logout manual
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function selectDays(days) {
            selectedDays = days;
            document.getElementById('selectedDays').value = days;
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`day-${i}`);
                if (btn) {
                    if (i === days) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            }
        }

        function handleTemplateSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('template-name').textContent = file.name;
                showToast("Plantilla cargada exitosamente");
            }
        }

        // --- MANEJO DE ARCHIVOS (IM츼GENES + DOCUMENTOS) ---
        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            const uploadArea = document.getElementById('upload-area');
            const originalText = uploadArea.innerHTML;
            uploadArea.innerHTML = '<span class="text-xs text-montessori-blue font-bold animate-pulse">Procesando...</span>';

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    if (attachedImages.length >= MAX_IMAGES) { showToast("L칤mite de im치genes alcanzado"); continue; }
                    try { const base64 = await compressImage(file, 800, 0.7); attachedImages.push(base64); } catch(e){ console.error(e); }
                } else if (file.type === 'application/pdf') {
                    try { 
                        const text = await extractTextFromPDF(file); 
                        attachedDocsText += `\n\n--- CONTENIDO PDF (${file.name}) ---\n${text.substring(0, 15000)}... [Truncado]`; 
                        renderDocPreview(file.name, 'PDF');
                    } catch(e){ showToast("Error leyendo PDF"); }
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    try {
                        const text = await extractTextFromDocx(file);
                        attachedDocsText += `\n\n--- CONTENIDO DOCX (${file.name}) ---\n${text.substring(0, 15000)}... [Truncado]`; 
                        renderDocPreview(file.name, 'DOCX');
                    } catch(e){ showToast("Error leyendo DOCX"); }
                }
            }
            renderImagePreviews();
            uploadArea.innerHTML = originalText;
            event.target.value = "";
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let fullText = "";
            const maxPages = Math.min(pdf.numPages, 5); // L칤mite de p치ginas para eficiencia
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(" ") + "\n";
            }
            return fullText;
        }

        async function extractTextFromDocx(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
            return result.value; 
        }

        function renderImagePreviews() {
            const grid = document.getElementById('images-grid');
            const uploadArea = document.getElementById('upload-area');
            const counter = document.getElementById('img-count');
            grid.innerHTML = ''; 
            if (attachedImages.length > 0) {
                grid.classList.remove('hidden');
                uploadArea.classList.remove('hidden'); 
                attachedImages.forEach((base64, index) => {
                    const div = document.createElement('div');
                    div.className = "relative group rounded-lg overflow-hidden border border-gray-200 aspect-square";
                    div.innerHTML = `<img src="${base64}" class="w-full h-full object-cover"><button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                    grid.appendChild(div);
                });
            } else { grid.classList.add('hidden'); uploadArea.classList.remove('hidden'); }
            counter.innerText = `${attachedImages.length}/${MAX_IMAGES}`;
        }

        function renderDocPreview(name, type) {
            const list = document.getElementById('docs-list');
            const item = document.createElement('div');
            item.className = "text-xs bg-gray-100 p-2 rounded flex justify-between items-center";
            item.innerHTML = `<span class="truncate font-bold text-gray-700">[${type}] ${name}</span>`;
            list.appendChild(item);
        }

        function removeImage(index) { attachedImages.splice(index, 1); renderImagePreviews(); }
        
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = event => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width; let h = img.height; if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; } canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.onerror = reject; }; reader.onerror = reject;
            });
        }

        // --- MODALS ---
        function toggleInstructionsModal() { document.getElementById('instructions-modal').classList.toggle('hidden'); }
        function saveInstructions() {
            const input = document.getElementById('instructions-input');
            const hiddenField = document.getElementById('customInstructions');
            const btn = document.getElementById('btn-instructions');
            const btnText = document.getElementById('btn-instructions-text');
            hiddenField.value = input.value.trim();
            toggleInstructionsModal();
            const count = attachedImages.length + (attachedDocsText ? 1 : 0);
            const hasText = hiddenField.value.length > 0;
            if (hasText || count > 0) {
                btn.className = "w-full py-2.5 px-3 rounded-lg bg-montessori-blue text-white border border-transparent shadow-md hover:bg-[#123145] transition-all duration-300 flex items-center justify-center gap-2 group";
                btnText.textContent = `Recursos (${count}) + Nota Guardada`;
            } else {
                btn.className = "w-full py-2.5 px-3 rounded-lg bg-gray-50 border border-dashed border-gray-300 text-gray-600 hover:text-montessori-blue hover:border-montessori-blue hover:bg-montessori-lightBlue transition-all duration-300 flex items-center justify-center gap-2 group";
                btnText.textContent = "Recursos (Img/PDF/Doc)";
            }
        }

        function toggleModificationModal() { 
            // Verificaci칩n estricta de cupo antes de abrir modal
            if (userQuota.remaining <= 0) {
                showQuotaExceededModal();
                return;
            }
            document.getElementById('modification-modal').classList.toggle('hidden'); 
        }
        
        async function applyModification() {
            // Verificaci칩n estricta de cupo
            if (userQuota.remaining <= 0) {
                showQuotaExceededModal();
                toggleModificationModal(); // Cerrar modal de input
                return;
            }

            const request = document.getElementById('modification-input').value;
            if(!request) return;
            toggleModificationModal();
            showToast("Aplicando cambios... espera un momento");
            await generatePlan(null, true, request);
        }

        // --- DROPDOWNS ---
        function initDropdowns() {}
        function toggleDropdown(type) {
            const list = document.getElementById(`${type}-dropdown-list`);
            const chevron = document.getElementById(`${type}-chevron`);
            if (list) {
                list.classList.toggle('hidden');
                if(chevron) chevron.classList.toggle('rotate-180');
            }
        }
        function selectDropdownValue(type, value) {
            if(type === 'style') {
                document.getElementById('teachingStyle').value = value;
                const textSpan = document.getElementById('selected-style-text');
                textSpan.textContent = value;
                textSpan.classList.remove('text-gray-500', 'font-normal');
                textSpan.classList.add('text-gray-900', 'font-medium');
            }
            document.getElementById(`${type}-dropdown-list`).classList.add('hidden');
            const chevron = document.getElementById(`${type}-chevron`);
            if(chevron) chevron.classList.remove('rotate-180');
        }

        document.addEventListener('click', function(e) {
            if(!e.target.closest('.custom-select-container')) {
                document.querySelectorAll('.custom-dropdown-list').forEach(list => {
                    list.classList.add('hidden');
                });
                document.querySelectorAll('[id$="-chevron"]').forEach(c => c.classList.remove('rotate-180'));
            }
        });

        // --- CORE: GENERACI칍N ---
        async function fetchWithRetry(url, options, retries = 3, delay = 2000) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 503 || response.status === 429) throw new Error("HTTP_OVERLOAD");
                    const clone = response.clone();
                    try { const data = await clone.json(); if (data.success === false && (data.error||"").toLowerCase().includes("overloaded")) throw new Error("LOGICAL_OVERLOAD"); } catch (e) {}
                    return response; 
                } catch (err) {
                    lastError = err;
                    if (i === retries - 1) throw err;
                    const loaderSubtitle = document.querySelector('#loader p');
                    if (loaderSubtitle) loaderSubtitle.innerText = `Servidores ocupados. Reintentando (${i+1}/${retries})...`;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 1.5; 
                }
            }
            if (lastError) throw lastError;
        }

        async function generatePlan(e, isModification = false, modificationRequest = "") {
            if(e) e.preventDefault();
            
            // 1. CHEQUEO ESTRICTO DE CUOTA AL INICIO
            if (userQuota.remaining <= 0) { 
                showQuotaExceededModal(); 
                return; 
            }

            const subject = document.getElementById('subject').value;
            const groupDetails = document.getElementById('groupDetails').value;
            let style = document.getElementById('teachingStyle').value || "Por Competencias";
            const topics = document.getElementById('topics').value;
            const daysCount = parseInt(document.getElementById('selectedDays').value);
            const extraInstructions = document.getElementById('customInstructions').value;

            // Detecci칩n autom치tica de idioma
            const subjectLower = subject.toLowerCase();
            let langInstruction = "";
            if (subjectLower.includes("ingles") || subjectLower.includes("english")) {
                langInstruction = "CRITICAL: GENERATE THE CONTENT IN ENGLISH.";
            } else if (subjectLower.includes("frances") || subjectLower.includes("french") || subjectLower.includes("francais")) {
                langInstruction = "CRITICAL: GENERATE THE CONTENT IN FRENCH.";
            }

            // System Prompt din치mico
            let baseInstruction = `
            Eres un planificador docente experto.
            Genera una planificaci칩n docente para ${daysCount} d칤as.
            Asignatura: ${subject}
            Grupo: ${groupDetails}
            Tema(s): ${topics}
            Estilo: ${style}
            
            ${langInstruction}
            
            MODO DE RESPUESTA: DETALLADO PERO CONCISO.
            Desarrolla las actividades con detalle pedag칩gico est치ndar, explicando claramente la din치mica.

            ${attachedDocsText ? "CONTEXTO DE DOCUMENTOS ADJUNTOS (Usa esto para crear las actividades): " + attachedDocsText : ""}
            ${extraInstructions ? "Instrucciones Extra: " + extraInstructions : ""}
            ${attachedImages.length > 0 ? "Nota: Se adjuntaron im치genes de referencia." : ""}

            REGLA PRINCIPAL: La suma total debe ser 60 minutos aprox.
            REGLAS DE FORMATO:
            1. PROHIBIDO T칈TULOS EN ACTIVIDADES (Ej: NO pongas "Actividad 1:", "Juego:", "Warm-up:"). Solo describe la acci칩n.
            2. TIEMPO SIEMPRE AL INICIO entre par칠ntesis.
            3. RESPONDE SOLO CON UN OBJETO JSON V츼LIDO.
            
            Estructura requerida JSON:
            {
              "asignatura": "${subject}",
              "unidad": "Nombre formal de la unidad",
              "lunes": { 
                  "tema": "...", 
                  "inicio": "...", 
                  "desarrollo": "...", 
                  "cierre": "...", 
                  "materiales_docente": "...", 
                  "recursos_alumno": "...", 
                  "tarea": "..." 
              },
              ... (hasta ${daysCount} d칤as)
            }
            `;

            let finalPrompt = "";
            if (isModification && currentPlanData) {
                baseInstruction += `\n\nPLAN ACTUAL JSON: ${JSON.stringify(currentPlanData)}`;
                finalPrompt = `El usuario quiere modificar el plan actual con esta solicitud: "${modificationRequest}". Genera el nuevo JSON completo con los cambios aplicados.`;
            } else {
                finalPrompt = `Generar plan de ${daysCount} d칤as para ${subject}.`;
            }

            document.getElementById('loader').classList.remove('hidden');
            if(!isModification) {
                document.getElementById('result-placeholder').classList.add('hidden');
                document.getElementById('result-content').classList.add('hidden');
            }
            document.getElementById('btn-generate').disabled = true;

            try {
                const payload = { prompt: finalPrompt, systemInstruction: baseInstruction };
                if (attachedImages.length > 0) payload.images = attachedImages;

                const response = await fetchWithRetry(API_GEN_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Error HTTP: " + response.status);
                const data = await response.json();
                if(!data.success) throw new Error(data.error || "Error desconocido.");

                let cleanText = data.text.replace(/```json/gi, '').replace(/```/g, '').trim();
                const start = cleanText.indexOf('{');
                const end = cleanText.lastIndexOf('}');
                if (start === -1) throw new Error("No se encontr칩 un bloque JSON v치lido.");
                let jsonCandidate = end > start ? cleanText.substring(start, end + 1) : cleanText.substring(start);
                jsonCandidate = jsonCandidate.replace(/\{\s*,/g, '{');

                try {
                    currentPlanData = JSON5.parse(jsonCandidate);
                } catch (e) {
                    console.warn("Intentando reparar JSON...", e);
                    // L칩gica de reparaci칩n b치sica
                    let loose = cleanText.substring(start);
                    let repaired = false;
                    for(let i=0; i<6; i++) {
                        try { currentPlanData = JSON5.parse(loose + "}".repeat(i)); repaired=true; break; } catch(err){}
                    }
                    if(!repaired) throw new Error("Error procesando respuesta del sistema.");
                }

                renderEditor(currentPlanData, daysCount);

                // 2. DESCUENTO DE CUOTA SIEMPRE (GENERACI칍N O MODIFICACI칍N)
                fetch(API_AUTH_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({ action: 'registerPlannerUsage', username: currentUser })
                }).then(res => res.json()).then(regData => {
                    if(regData.success) { 
                        // Actualizar con el valor real del servidor si viene, sino estimar localmente
                        userQuota.remaining = (regData.remaining !== undefined) ? regData.remaining : Math.max(0, userQuota.remaining - 1);
                        updateQuotaDisplay();
                        checkQuotaLimits(); // Validar si qued칩 en 0 tras este uso
                    }
                });

                document.getElementById('loader').classList.add('hidden');
                const resCont = document.getElementById('result-content');
                resCont.classList.remove('hidden');
                resCont.classList.add('flex');
                requestAnimationFrame(() => resCont.classList.remove('translate-y-4', 'opacity-0'));
                
                document.getElementById('btn-modify').classList.remove('hidden');
                
                const fileInput = document.getElementById('template-upload');
                if (fileInput.files.length > 0) {
                    document.getElementById('btn-download-word').classList.remove('hidden');
                }

            } catch (error) {
                console.error("ERROR:", error);
                document.getElementById('loader').classList.add('hidden');
                if(!isModification) document.getElementById('result-placeholder').classList.remove('hidden');
                showToast("Error: " + error.message);
            } finally {
                // Solo rehabilitar si a칰n hay cupo
                if(userQuota.remaining > 0) {
                    document.getElementById('btn-generate').disabled = false;
                } else {
                    checkQuotaLimits();
                }
            }
        }

        function renderEditor(data, daysCount) {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            const daysMap = [
                { key: 'lunes', label: 'Lunes' },
                { key: 'martes', label: 'Martes' },
                { key: 'miercoles', label: 'Mi칠rcoles' },
                { key: 'jueves', label: 'Jueves' },
                { key: 'viernes', label: 'Viernes' }
            ];

            for(let i = 0; i < daysCount; i++) {
                const dayInfo = daysMap[i];
                const dayData = data[dayInfo.key] || {};
                
                const card = document.createElement('div');
                card.className = 'plan-card';
                card.innerHTML = `
                    <h3 class="day-header">${dayInfo.label}</h3>
                    <label class="section-label">Tema / Contenido</label><textarea id="topic_${dayInfo.key}" class="editable-field field-topic">${dayData.tema || ''}</textarea>
                    <label class="section-label">1. INICIO</label><textarea id="inicio_${dayInfo.key}" class="editable-field" style="height: 5rem;">${dayData.inicio || ''}</textarea>
                    <label class="section-label">2. DESARROLLO</label><textarea id="desarrollo_${dayInfo.key}" class="editable-field" style="height: 8rem;">${dayData.desarrollo || ''}</textarea>
                    <label class="section-label">3. CIERRE</label><textarea id="cierre_${dayInfo.key}" class="editable-field" style="height: 5rem;">${dayData.cierre || ''}</textarea>
                    <label class="section-label">MATERIALES DOCENTE</label><textarea id="materiales_docente_${dayInfo.key}" class="editable-field field-materials">${dayData.materiales_docente || ''}</textarea>
                    <label class="section-label">RECURSOS ALUMNO</label><textarea id="recursos_alumno_${dayInfo.key}" class="editable-field field-materials">${dayData.recursos_alumno || ''}</textarea>
                    <label class="section-label">TAREA</label><textarea id="tarea_${dayInfo.key}" class="editable-field" style="height: 3rem;">${dayData.tarea || ''}</textarea>
                `;
                container.appendChild(card);
            }
        }

        function getValueOrEmpty(id) {
            const el = document.getElementById(id);
            return el ? el.value || '' : '';
        }

        function downloadWord() {
            const fileInput = document.getElementById('template-upload');
            const btn = document.getElementById('btn-download-word');

            if (fileInput.files.length === 0) { showToast("Sube tu plantilla .docx primero"); return; }

            btn.classList.add('animate-success-feedback');
            setTimeout(() => { btn.classList.remove('animate-success-feedback'); }, 300);

            const safePlanData = currentPlanData || {};
            const finalData = {
                asignatura: getValueOrEmpty('subject'),
                unidad: safePlanData.unidad || "Unidad no definida",
                tema_lunes: getValueOrEmpty('topic_lunes'), inicio_lunes: getValueOrEmpty('inicio_lunes'), desarrollo_lunes: getValueOrEmpty('desarrollo_lunes'), cierre_lunes: getValueOrEmpty('cierre_lunes'), materiales_docente_lunes: getValueOrEmpty('materiales_docente_lunes'), recursos_alumno_lunes: getValueOrEmpty('recursos_alumno_lunes'), tarea_lunes: getValueOrEmpty('tarea_lunes'),
                tema_martes: getValueOrEmpty('topic_martes'), inicio_martes: getValueOrEmpty('inicio_martes'), desarrollo_martes: getValueOrEmpty('desarrollo_martes'), cierre_martes: getValueOrEmpty('cierre_martes'), materiales_docente_martes: getValueOrEmpty('materiales_docente_martes'), recursos_alumno_martes: getValueOrEmpty('recursos_alumno_martes'), tarea_martes: getValueOrEmpty('tarea_martes'),
                tema_miercoles: getValueOrEmpty('topic_miercoles'), inicio_miercoles: getValueOrEmpty('inicio_miercoles'), desarrollo_miercoles: getValueOrEmpty('desarrollo_miercoles'), cierre_miercoles: getValueOrEmpty('cierre_miercoles'), materiales_docente_miercoles: getValueOrEmpty('materiales_docente_miercoles'), recursos_alumno_miercoles: getValueOrEmpty('recursos_alumno_miercoles'), tarea_miercoles: getValueOrEmpty('tarea_miercoles'),
                tema_jueves: getValueOrEmpty('topic_jueves'), inicio_jueves: getValueOrEmpty('inicio_jueves'), desarrollo_jueves: getValueOrEmpty('desarrollo_jueves'), cierre_jueves: getValueOrEmpty('cierre_jueves'), materiales_docente_jueves: getValueOrEmpty('materiales_docente_jueves'), recursos_alumno_jueves: getValueOrEmpty('recursos_alumno_jueves'), tarea_jueves: getValueOrEmpty('tarea_jueves'),
                tema_viernes: getValueOrEmpty('topic_viernes'), inicio_viernes: getValueOrEmpty('inicio_viernes'), desarrollo_viernes: getValueOrEmpty('desarrollo_viernes'), cierre_viernes: getValueOrEmpty('cierre_viernes'), materiales_docente_viernes: getValueOrEmpty('materiales_docente_viernes'), recursos_alumno_viernes: getValueOrEmpty('recursos_alumno_viernes'), tarea_viernes: getValueOrEmpty('tarea_viernes'),
            };

            const reader = new FileReader();
            
            // FIX: Usar ArrayBuffer en lugar de BinaryString para mayor compatibilidad
            reader.readAsArrayBuffer(fileInput.files[0]);

            reader.onload = function(evt) {
                try {
                    // Cargar contenido con PizZip
                    const content = evt.target.result;
                    const zip = new PizZip(content);
                    
                    const doc = new window.docxtemplater(zip, { 
                        paragraphLoop: true, 
                        linebreaks: true,
                        nullGetter: function(part) { return ""; } 
                    });
                    
                    doc.render(finalData);
                    
                    // Generar blob
                    const out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    });
                    
                    const abbreviate = (text) => {
                        if (!text) return "XX";
                        const clean = text.replace(/[^a-zA-Z0-9치칠칤칩칰츼칄칈칍칔침칌\s]/g, "").trim();
                        const ignore = ["de", "del", "la", "el", "los", "las", "y", "en"];
                        const words = clean.split(/\s+/).filter(w => !ignore.includes(w.toLowerCase()) && w.length > 0);
                        if (words.length === 0) return "XX";
                        return words.length === 1 ? words[0].substring(0, 3).toUpperCase() : words.map(w => w.charAt(0)).join('').toUpperCase();
                    };

                    const cursoAbrev = abbreviate(getValueOrEmpty('groupDetails'));
                    const materiaAbrev = abbreviate(getValueOrEmpty('subject'));
                    const months = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
                    const currentMonth = months[new Date().getMonth()];
                    saveAs(out, `${cursoAbrev}-${materiaAbrev} | DD-DD ${currentMonth}.docx`);
                    showToast("춰Descarga iniciada!");
                } catch (error) {
                    console.error("Error Word:", error);
                    showToast("Error al generar Word. 쮼l archivo es v치lido?");
                }
            };
            
            reader.onerror = function() {
                showToast("Error al leer el archivo de plantilla.");
            };
        }
    </script>
</body>
</html>
