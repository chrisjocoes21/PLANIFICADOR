<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- FIX UX: Evita zoom automático en inputs en iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planificador Docente - Pinceladas Montessori</title>
    
    <!-- OPTIMIZACIÓN DE CONEXIÓN -->
    <link rel="preconnect" href="https://docs.google.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2210%22 y=%2240%22 width=%2220%22 height=%2250%22 rx=%224%22 fill=%22%23002060%22/><rect x=%2240%22 y=%2225%22 width=%2220%22 height=%2265%22 rx=%224%22 fill=%22%23002060%22/><rect x=%2270%22 y=%2210%22 width=%2220%22 height=%2280%22 rx=%224%22 fill=%22%23C00000%22/></svg>">

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Chewy&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- LIBRERÍAS PARA WORD (Frontend) -->
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.49.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- FIX FUNCIONAL: JSON5 para parsing robusto de respuestas IA -->
    <script src="https://unpkg.com/json5@2/dist/index.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        montserrat: ['Montserrat', 'sans-serif'],
                        chewy: ['Chewy', 'cursive']
                    },
                    colors: {
                        montessori: {
                            blue: '#002060',
                            red: '#C00000',
                            yellow: '#FFD966',
                            gray: '#F3F4F6',
                            lightBlue: '#EFF6FF'
                        }
                    },
                    boxShadow: {
                        'card-hover': '0 15px 30px -5px rgba(0, 0, 0, 0.08), 0 10px 12px -6px rgba(0, 0, 0, 0.02)',
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.03)'
                    },
                    animation: {
                        'diagonal-shift': 'diagonalShift 3s ease-in-out infinite alternate',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blue-red': 'blueRedCycle 3s infinite cubic-bezier(0.4, 0, 0.2, 1)',
                    },
                    keyframes: {
                        diagonalShift: {
                            '0%': { 'background-position': '0% 0%' },
                            '100%': { 'background-position': '100% 100%' },
                        },
                        blueRedCycle: {
                            '0%, 100%': { color: '#002060' }, 
                            '50%': { color: '#C00000' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* CONTROL DE LAYOUT PRINCIPAL */
        body { 
            background-color: #f8fafc; 
            height: 100vh; 
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- SCROLL INVISIBLE GLOBAL --- */
        *::-webkit-scrollbar {
            display: none;
            width: 0 !important;
            height: 0 !important;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
            touch-action: manipulation;
        }

        .custom-scroll { 
            overflow-y: auto;
        }

        /* --- FONDO ANIMADO --- */
        .particles-container {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .grade-particle {
            position: absolute;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900; 
            opacity: 0;
            user-select: none;
            text-shadow: 0 2px 4px rgba(255,255,255,0.5); 
        }

        .grade-particle.blue { color: rgba(0, 32, 96, 0.25); }
        .grade-particle.red { color: rgba(192, 0, 0, 0.25); }

        .grade-particle.background {
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(110vh) scale(0.8) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10vh) scale(1.1) rotate(var(--rotation)); opacity: 0; }
        }

        .grid-overlay {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 32, 96, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 32, 96, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
        }

        .animated-diagonal-background {
            background: repeating-linear-gradient(
                45deg, 
                #DBEAFE 0%,
                #DBEAFE 40%, 
                #FEE2E2 60%,
                #FEE2E2 100%
            );
            background-size: 200vw 200vh;
            animation: diagonalShift 3s ease-in-out infinite alternate; 
            position: absolute; 
            inset: 0;
            z-index: 0;
            will-change: background-position, transform; 
        }

        /* Tipografía */
        .text-colegio { color: #002060; font-family: 'Montserrat', sans-serif; font-weight: 700; letter-spacing: 1px; line-height: 1; }
        .text-pinceladas { font-family: 'Chewy', cursive; color: #C00000; line-height: 1; }
        .text-montessori-sub { background-color: #002060; color: #ffffff; padding: 0.1em 0.3em; border-radius: 50px; font-family: 'Montserrat', sans-serif; font-weight: 700; display: flex; justify-content: center; align-items: center; letter-spacing: 0.1em; }
        
        .logo-sm .text-colegio { font-size: 0.55rem; }
        .logo-sm .text-pinceladas { font-size: 1.3rem; }
        .logo-sm .text-montessori-sub { font-size: 0.55rem; padding: 1px 4px; }
        
        .logo-lg .text-colegio { font-size: clamp(1rem, 2.5vw, 1.2rem); }
        .logo-lg .text-pinceladas { font-size: clamp(2.5rem, 6vw, 3.2rem); }
        .logo-lg .text-montessori-sub { font-size: clamp(1rem, 2.5vw, 1.2rem); }

        /* Estilos del Editor Manual */
        .plan-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .plan-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .day-header {
            color: #C00000;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1rem;
            border-bottom: 2px solid #fee2e2;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .section-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 0.3rem;
            letter-spacing: 0.05em;
        }

        .editable-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            /* FIX UX: text-base en mobile previene zoom */
            font-size: 16px; 
            line-height: 1.5;
            color: #334155;
            background-color: #f8fafc;
            transition: all 0.2s;
            resize: none;
            outline: none;
        }

        @media (min-width: 768px) {
            .editable-field { font-size: 0.875rem; }
        }
        
        .editable-field:focus {
            background-color: #ffffff;
            border-color: #002060;
            box-shadow: 0 0 0 3px rgba(0, 32, 96, 0.1);
        }
        
        .field-topic { height: 3rem; font-weight: 600; }
        .field-activities { height: 8rem; }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* --- ANIMACIONES GENERALES --- */
        @keyframes colorPulse { 
            0% { color: #9CA3AF; } 
            25% { color: #C00000; } 
            50% { color: #9CA3AF; } 
            75% { color: #002060; } 
            100% { color: #9CA3AF; } 
        }
        .animate-pulse-color { animation: colorPulse 8s ease-in-out infinite; }
        
        .fade-out { animation: fadeOut 0.4s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.99); pointer-events: none; } }
        
        /* Loader circular (Login) */
        .loader {
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top: 3px solid #ffffff;
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #btn-login { min-height: 48px; }
        #btn-text { transition: opacity 0.3s; }
        #btn-text.hidden-text { opacity: 0; }

        @keyframes blueRedCycle {
            0%, 100% { color: #002060; } 
            50% { color: #C00000; }      
        }
        .animate-blue-red { animation: blueRedCycle 3s infinite cubic-bezier(0.4, 0, 0.2, 1); }

        /* CUSTOM SELECT STYLES */
        .custom-select-container { position: relative; width: 100%; }
        .custom-select-trigger { 
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 0.625rem 1rem; 
            background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem;
            font-size: 0.875rem; font-weight: 500; color: #1f2937;
            cursor: pointer; transition: all 0.2s;
        }
        .custom-select-trigger:hover { border-color: #002060; }
        
        /* Dropdown list styles */
        .custom-dropdown-list {
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0;
            background-color: white; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem;
            margin-top: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 60; 
            max-height: 200px; 
            overflow-y: auto;
        }
        
        .custom-dropdown-list button {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem; 
            text-align: left;
            font-size: 0.875rem; 
            color: #374151; 
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        
        .custom-dropdown-list button:hover { 
            background-color: #EFF6FF; 
            color: #002060; 
        }

        /* ESTILO PARA BOTONES DE DÍA CORREGIDO */
        .day-btn.active {
            background-color: #002060; 
            color: white; 
            border-color: #002060;
            box-shadow: 0 2px 5px rgba(0, 32, 96, 0.2);
        }

    </style>
</head>
<body class="text-slate-800 font-sans antialiased">

    <!-- PRELOADER -->
    <div id="initial-loader" class="fixed inset-0 z-[300] flex items-center justify-center bg-blue-50 transition-all duration-700">
        <div class="animated-diagonal-background animate-diagonal-shift"></div>
        <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        <div class="relative z-20 flex flex-col items-center justify-center">
            <h1 class="text-5xl md:text-7xl font-bold font-montserrat animate-blue-red drop-shadow-sm text-center leading-tight">Cargando...</h1>
        </div>
    </div>
    
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-blue-50 overflow-hidden transition-all duration-700">
        <div class="animated-diagonal-background animate-diagonal-shift"></div>
        <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        
        <div id="login-card" class="relative z-20 w-full max-w-3xl mx-4 transition-all duration-700">
            <div class="bg-white/90 backdrop-blur-xl border border-white/50 rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[380px]">
                <div class="w-full md:w-5/12 bg-gray-50/80 flex flex-col items-center justify-center p-6 border-b md:border-b-0 md:border-r border-gray-100 gap-4">
                    <div class="logo-container logo-lg cursor-default text-center transform scale-90 md:scale-100">
                        <div class="text-section flex flex-col items-center">
                            <div class="text-colegio">COLEGIO</div>
                            <div class="text-pinceladas">Pinceladas</div>
                            <div class="text-montessori-sub w-full text-center">MONTESSORI</div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 font-medium text-center hidden md:block mt-2">Herramienta de Planificación</p>
                </div>
                <div class="w-full md:w-7/12 p-6 md:p-8 flex flex-col justify-center">
                    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Credenciales de Acceso</label>
                            <div class="space-y-3">
                                <div class="relative group z-20">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-600 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </div>
                                    <!-- FIX UX: text-base en inputs para evitar zoom en iOS -->
                                    <input type="text" id="username" required class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-white border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-500 text-base md:text-sm placeholder-gray-600" placeholder="Usuario">
                                </div>
                                <div class="relative group z-20">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-600 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    </div>
                                    <input type="password" id="password" required class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-white border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-500 text-base md:text-sm placeholder-gray-600" placeholder="Contraseña">
                                </div>
                            </div>
                        </div>
                        <div id="login-status-container" class="min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border border-transparent text-center px-2 py-1 bg-gray-50">
                             <span id="login-status-text" class="text-xs font-medium text-gray-600">Ingrese sus credenciales para continuar</span>
                        </div>
                        <button type="submit" id="btn-login" class="relative w-full bg-montessori-blue text-white font-bold text-sm py-3 rounded-lg shadow-lg shadow-montessori-blue/30 hover:bg-montessori-blue hover:shadow-montessori-blue/50 hover:scale-[1.01] active:scale-[0.99] transition-all duration-300 flex justify-center items-center">
                            <span id="btn-text">Iniciar Sesión</span>
                            <div id="btn-loader" class="loader hidden absolute w-5 h-5 border-2"></div>
                        </button>
                    </form>
                    <!-- BOTÓN DE SOPORTE -->
                    <div class="mt-4 text-center">
                        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=gestion.educativa.pinceladas@gmail.com" target="_blank" class="text-[10px] text-gray-600 hover:text-montessori-blue transition-colors font-medium inline-flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            Soporte Técnico
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE ACCESO DENEGADO -->
    <div id="access-denied-modal" class="hidden fixed inset-0 z-[210] flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 border border-gray-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-50 mb-4 animate-pulse">
                    <svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                </div>
                <h3 class="text-xl leading-6 font-bold text-gray-900 mb-2">Acceso Restringido</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-600 mb-6">Su perfil de usuario no cuenta con los permisos necesarios para utilizar la herramienta de <strong>Planificación Docente</strong>.</p>
                    <p class="text-xs text-montessori-blue font-bold bg-blue-50 p-3 rounded-lg">Para solicitar acceso a esta funcionalidad específica, por favor comuníquese con el Tío Christopher.</p>
                </div>
                <div class="mt-6">
                    <button type="button" onclick="logout()" class="w-full inline-flex justify-center items-center rounded-xl border border-transparent shadow-md px-4 py-3 bg-gray-800 text-base font-bold text-white hover:bg-gray-700 focus:outline-none transition-all transform hover:-translate-y-0.5">Entendido, Cerrar Sesión</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL INSTRUCCIONES MEJORADO -->
    <div id="instructions-modal" class="hidden fixed inset-0 z-[250] flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 border border-gray-100 flex flex-col h-[85vh] transition-all transform duration-300">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100 flex-shrink-0">
                <h3 class="text-lg font-bold text-montessori-blue font-montserrat flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Recursos & Instrucciones
                </h3>
                <button onclick="toggleInstructionsModal()" class="text-gray-400 hover:text-montessori-red transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 flex flex-col md:flex-row gap-6 overflow-hidden">
                <!-- Columna Izquierda: Instrucciones -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Instrucciones Adicionales / Adaptaciones</label>
                    <textarea id="instructions-input" class="w-full flex-1 p-4 rounded-xl bg-gray-50 border border-gray-200 text-sm focus:border-montessori-blue focus:ring-2 focus:ring-blue-100 outline-none resize-none transition-all" placeholder="Ej: Enfocarse en ejercicios prácticos, usar materiales concretos, adaptar para alumno con TDAH..."></textarea>
                </div>

                <!-- Columna Derecha: Imágenes -->
                <div class="flex-1 flex flex-col overflow-hidden border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-6">
                    <div class="flex justify-between items-end mb-2 flex-shrink-0">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Fotos del Libro / Actividad</label>
                        <span id="img-count" class="text-[10px] text-gray-400 font-medium">0/6</span>
                    </div>
                    
                    <input type="file" id="image-upload" accept="image/*" multiple class="hidden" onchange="handleImageUpload(event)">
                    
                    <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-gray-50 transition-colors cursor-pointer flex-shrink-0" onclick="document.getElementById('image-upload').click()">
                        <div class="text-gray-400 flex flex-col items-center gap-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="text-xs font-medium">Toca para adjuntar fotos</span>
                        </div>
                    </div>

                    <div id="images-grid" class="hidden grid grid-cols-2 lg:grid-cols-3 gap-2 mt-3 overflow-y-auto custom-scroll pr-1">
                        <!-- Imágenes -->
                    </div>
                </div>
            </div>

            <div class="mt-4 flex justify-end gap-3 pt-3 border-t border-gray-100 flex-shrink-0">
                <button onclick="toggleInstructionsModal()" class="px-4 py-2 text-sm text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button onclick="saveInstructions()" class="px-6 py-2 bg-montessori-blue text-white text-sm font-bold rounded-lg hover:bg-blue-800 transition-colors shadow-lg shadow-blue-900/20">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-content" class="hidden flex flex-col h-screen w-full relative z-0 opacity-0 transition-opacity duration-1000 overflow-hidden">
        
        <!-- Fondo -->
        <div class="fixed inset-0 z-0">
            <div class="animated-diagonal-background"></div>
            <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        </div>

        <!-- HEADER -->
        <header class="bg-white/90 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-50 h-16 flex-shrink-0 w-full shadow-sm">
            <div class="w-full px-6 h-full flex justify-between items-center">
                <div class="logo-container logo-sm select-none flex flex-col items-center cursor-pointer" onclick="location.reload()">
                    <div class="text-section flex flex-col items-center transform scale-90 md:scale-100 origin-left">
                        <div class="text-colegio">COLEGIO</div>
                        <div class="text-pinceladas">Pinceladas</div>
                        <div class="text-montessori-sub w-full text-center">MONTESSORI</div>
                    </div>
                </div>
                
                <!-- Info de Usuario -->
                <div class="flex items-center gap-4">
                    <div class="flex flex-col items-end mr-2">
                         <div class="flex items-center gap-1">
                             <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest leading-tight">Hola,</span>
                             <span id="user-name-display" class="text-xs font-black text-montessori-blue leading-tight max-w-[150px] truncate text-right">Usuario</span>
                         </div>
                         <div class="bg-blue-50 px-3 py-1 rounded-lg mt-1 border border-blue-100 flex items-center justify-center gap-2 h-6" id="quota-badge">
                             <span class="text-[10px] font-bold text-gray-500 uppercase leading-none">Usos hoy:</span>
                             <span id="usage-counter" class="text-xs font-black text-montessori-red leading-none pt-[1px]">...</span>
                         </div>
                    </div>
                    <button onclick="logout()" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors" title="Cerrar Sesión">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-1 w-full relative z-10 overflow-hidden flex flex-col md:flex-row p-4 md:p-6 gap-6 min-h-0">
            
            <!-- PANEL IZQUIERDO: CONFIGURACIÓN -->
            <div class="w-full md:w-1/4 flex flex-col gap-4 overflow-y-auto custom-scroll pr-1 pb-20 md:pb-0 h-full flex-shrink-0">
                <div class="bg-white/95 backdrop-blur rounded-2xl p-6 border border-white shadow-soft hover:shadow-card-hover transition-all duration-300 flex flex-col h-full overflow-y-auto custom-scroll">
                    <!-- HEADER COMPACTO -->
                    <div class="flex items-center gap-2 mb-4 pb-2 border-b border-gray-100 pb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-montessori-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                        <h2 class="text-sm font-bold text-slate-800 font-montserrat">Datos de Clase</h2>
                    </div>

                    <form id="plannerForm" class="space-y-3 flex-1 flex flex-col" onsubmit="generatePlan(event)">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Asignatura</label>
                            <!-- FIX UX: text-base en inputs para evitar zoom en iOS -->
                            <input type="text" id="subject" placeholder="Ingrese la Asignatura" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue text-base md:text-sm font-medium">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Grupo</label>
                            <input type="text" id="groupDetails" placeholder="Ej. 3ro Primaria" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue text-base md:text-sm font-medium">
                        </div>

                        <!-- SELECT MODERNIZADO -->
                        <div class="relative custom-select-container">
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Estilo Pedagógico</label>
                            <div id="style-dropdown-btn" class="custom-select-trigger" onclick="toggleDropdown('style')">
                                <span id="selected-style-text">Por Competencias</span>
                                <svg class="h-4 w-4 text-gray-600 transform transition-transform duration-200" id="style-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            </div>
                            <div id="style-dropdown-list" class="custom-dropdown-list hidden">
                                <button type="button" onclick="selectDropdownValue('style', 'Tradicional')">Tradicional</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Montessori')">Montessori</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Gamificación')">Gamificación</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Líder en Mí')">Líder en Mí</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Adecuación Curricular')">Adecuación Curricular</button>
                                <button type="button" onclick="selectDropdownValue('style', 'Enseñanza por Competencias')">Enseñanza por Competencias</button>
                            </div>
                            <input type="hidden" id="teachingStyle" value="Por Competencias">
                        </div>
                        
                        <!-- SECCIÓN NUEVA: CARGA DE PLANTILLA WORD -->
                        <div class="border-t border-gray-100 pt-3 mt-1">
                            <label class="block text-xs font-bold text-montessori-blue uppercase tracking-wider mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Exportar a Word
                            </label>
                            <div class="relative">
                                <input type="file" id="template-upload" accept=".docx" class="hidden" onchange="handleTemplateSelect(event)">
                                <label for="template-upload" class="flex items-center justify-between w-full px-3 py-2 bg-blue-50 border border-blue-100 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                    <span id="template-name" class="text-xs text-blue-800 font-medium truncate max-w-[180px]">Cargar Plantilla (.docx)</span>
                                    <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                </label>
                            </div>
                            <p class="text-[9px] text-gray-400 mt-1 leading-tight">Usa etiquetas como {tema_lunes} en tu Word.</p>
                        </div>

                        <!-- SELECTOR DE DÍAS -->
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Clases</label>
                            <div class="grid grid-cols-5 gap-2">
                                <button type="button" onclick="selectDays(1)" id="day-1" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600">1</button>
                                <button type="button" onclick="selectDays(2)" id="day-2" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600">2</button>
                                <button type="button" onclick="selectDays(3)" id="day-3" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600">3</button>
                                <button type="button" onclick="selectDays(4)" id="day-4" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600">4</button>
                                <button type="button" onclick="selectDays(5)" id="day-5" class="day-btn py-2 text-xs font-bold rounded-lg border border-gray-200 bg-white hover:border-montessori-blue hover:text-montessori-blue transition-all text-gray-600 active">5</button>
                            </div>
                            <input type="hidden" id="selectedDays" value="5">
                        </div>

                        <!-- TEMAS -->
                        <div class="flex flex-col min-h-0">
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Temas</label>
                            <!-- FIX UX: text-base en inputs para evitar zoom en iOS -->
                            <textarea id="topics" class="w-full h-12 px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-300 text-base md:text-sm font-medium resize-none" placeholder="Describa los temas..."></textarea>
                        </div>
                        
                        <button type="button" id="btn-instructions" onclick="toggleInstructionsModal()" class="w-full py-2.5 px-3 rounded-lg bg-gray-50 border border-dashed border-gray-300 text-gray-600 hover:text-montessori-blue hover:border-montessori-blue hover:bg-blue-50 transition-all duration-300 flex items-center justify-center gap-2 group">
                            <span class="text-xs font-bold truncate" id="btn-instructions-text">Añadir Instrucciones / Fotos</span>
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        </button>
                        <input type="hidden" id="customInstructions" value="">

                        <button type="submit" id="btn-generate" class="group relative w-full bg-montessori-blue hover:bg-blue-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-montessori-blue/30 transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-2 overflow-hidden mt-4">
                            <span class="relative z-10 flex items-center gap-2">GENERAR PLAN</span>
                            <div class="absolute inset-0 h-full w-full scale-0 rounded-2xl transition-all duration-300 group-hover:scale-100 group-hover:bg-white/10"></div>
                        </button>
                    </form>
                </div>
            </div>

            <!-- PANEL DERECHO: RESULTADOS (EDITOR MANUAL) -->
            <div class="w-full md:w-3/4 h-full flex flex-col relative min-h-0">
                
                <!-- Placeholder -->
                <div id="result-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 bg-white/50 backdrop-blur-sm border-2 border-dashed border-gray-300 rounded-2xl">
                    <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-4 animate-pulse-slow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-montessori-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 font-montserrat mb-2">Editor de Planificación</h3>
                    <p class="text-gray-500 text-sm max-w-sm">Genera un plan con IA, edita el contenido tarjeta por tarjeta y expórtalo a tu Word personalizado.</p>
                </div>

                <!-- Loader -->
                <div id="loader" class="hidden absolute inset-0 z-20 flex items-center justify-center bg-white/90 backdrop-blur-sm rounded-2xl transition-all duration-300">
                    <div class="flex flex-col items-center">
                        <div class="relative w-20 h-20 mb-6">
                            <div class="absolute inset-0 rounded-full border-4 border-gray-100"></div>
                            <div class="absolute inset-0 rounded-full border-4 border-montessori-red border-t-transparent animate-spin"></div>
                            <div class="absolute inset-3 rounded-full border-4 border-montessori-blue border-t-transparent animate-spin" style="animation-direction: reverse; animation-duration: 2s;"></div>
                        </div>
                        <div class="text-center space-y-2">
                            <h3 class="text-lg font-bold text-montessori-blue font-montserrat animate-pulse">Analizando Recursos...</h3>
                            <p class="text-xs text-gray-500 font-medium">Creando actividades personalizadas...</p>
                        </div>
                    </div>
                </div>

                <!-- Contenedor de Resultados con Editor -->
                <div id="result-content" class="hidden h-full flex-col bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 relative z-10 transition-all duration-500 transform translate-y-4 opacity-0 flex-1">
                    
                    <!-- BARRA SUPERIOR -->
                    <div class="flex justify-between items-center px-4 py-2 bg-gray-50 border-b border-gray-200 flex-shrink-0 h-14">
                        <div class="flex items-center gap-2">
                             <div class="flex flex-col">
                                <span class="text-sm font-bold text-gray-700">Editor de Contenido</span>
                                <span class="text-[10px] text-gray-500">Los cambios se guardarán al descargar</span>
                             </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <!-- BOTÓN DESCARGA WORD -->
                            <button id="btn-download-word" onclick="downloadWord()" class="hidden flex items-center gap-2 px-4 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-md transition-all font-bold text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                DESCARGAR WORD
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÁREA DE EDICIÓN MANUAL (GRID DE TARJETAS) -->
                    <div class="flex-1 overflow-y-auto custom-scroll p-6 bg-gray-50/50" id="editor-container">
                        <!-- AQUÍ SE INYECTARÁN LAS TARJETAS (JS) -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-white/90 backdrop-blur-sm border-t border-gray-200 py-4 mt-auto flex-shrink-0 w-full z-10">
            <div class="text-center text-[10px] sm:text-xs text-gray-600">
                <a href="https://chrisjocoes21.github.io/PORTAFOLIO/" target="_blank" class="animate-pulse-color font-medium transition-colors hover:text-montessori-blue hover:underline" title="Visitar Portafolio">
                    © 2025 Planificador Académico - Desarrollado por Didac-Click Group.
                </a>
            </div>
        </footer>
    </div>

    <div class="h-4"></div>
    <div id="toast"></div>

    <script>
        // CONFIGURACIÓN ARQUITECTURA HÍBRIDA
        const API_AUTH_URL = "https://script.google.com/macros/s/AKfycbwnNusWP5LlxipynwTszW7bz70GNZa4n3RfEm-8tsM7nFktVeNvXATqz8HddKY_2YK9/exec";
        const API_GEN_URL = "https://script.google.com/macros/s/AKfycbyYTp9lY07wCjxtwMrFZth_78nJm02gUyTK1V72Ngab9VHbChYAzzteBEUy4VzOZCcGWw/exec";
        
        let selectedDays = 5;
        let currentUser = null;
        let dailyQuota = { remaining: 0, total: 0 };
        let attachedImages = [];
        const MAX_IMAGES = 6;
        let currentPlanData = null; // Almacenará el JSON original de la IA

        // --- PARTÍCULAS DEL FONDO ---
        const symbols = ['100', 'A+', 'A', '10', '✓', '95', 'B+', '★', '90', 'A', '100'];

        function initAllParticles() {
            const containers = document.querySelectorAll('.particles-container');
            containers.forEach(container => {
                container.innerHTML = '<div class="grid-overlay"></div>';
                createParticlesForContainer(container);
            });
        }

        function createParticlesForContainer(container) {
            const particleCount = 18; 
            for (let i = 0; i < particleCount; i++) {
                const span = document.createElement('span');
                span.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                span.classList.add('grade-particle');
                if (Math.random() > 0.5) span.classList.add('blue');
                else span.classList.add('red');

                const rotation = Math.floor(Math.random() * 40 - 20);
                span.style.setProperty('--rotation', `${rotation}deg`);

                span.classList.add('background');
                const left = Math.random() * 100;
                const duration = 15 + Math.random() * 20; 
                const delay = Math.random() * -30; 
                const size = 0.8 + Math.random() * 1.2; 

                span.style.left = `${left}%`;
                span.style.animationDuration = `${duration}s`;
                span.style.animationDelay = `${delay}s`;
                span.style.fontSize = `${size}rem`;

                container.appendChild(span);
            }
        }
        
        // --- SISTEMA DE LOGIN Y SESIÓN ---

        window.onload = function() {
            initAllParticles();
            checkSession();
        };

        function checkSession() {
            const session = sessionStorage.getItem('pinceladas_session');
            const loader = document.getElementById('initial-loader');

            if (session) {
                const data = JSON.parse(session);
                loginUserSuccess(data.name, data.usernameUnique, true);
            } else {
                setTimeout(() => {
                    loader.classList.add('opacity-0');
                    setTimeout(() => loader.classList.add('hidden'), 700);
                }, 1000);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('btn-loader');
            const statusBox = document.getElementById('login-status-container');
            const statusText = document.getElementById('login-status-text');

            btnText.classList.add('hidden-text'); 
            loader.classList.remove('hidden');
            btn.disabled = true;
            statusBox.className = "min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border px-2 py-1 bg-blue-50 border-blue-200";
            statusText.className = "text-xs font-bold text-blue-600";
            statusText.innerText = "Verificando credenciales...";

            try {
                const response = await fetch(`${API_AUTH_URL}?action=login&username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`);
                const data = await response.json();

                if (data.success) {
                    statusText.innerText = "Verificando privilegios de acceso...";
                    const quotaResponse = await fetch(`${API_AUTH_URL}?action=checkPlannerQuota&username=${encodeURIComponent(data.usernameUnique)}`);
                    const quotaData = await quotaResponse.json();

                    if (quotaData.success) {
                        if (quotaData.restricted) {
                            showAccessDeniedModal();
                            btnText.classList.remove('hidden-text');
                            loader.classList.add('hidden');
                            btn.disabled = false;
                        } else {
                            const sessionData = {
                                name: data.name,
                                usernameUnique: data.usernameUnique,
                                loginTime: new Date().getTime()
                            };
                            sessionStorage.setItem('pinceladas_session', JSON.stringify(sessionData));
                            
                            dailyQuota.remaining = quotaData.remaining;
                            dailyQuota.total = quotaData.limit;
                            
                            loginUserSuccess(data.name, data.usernameUnique, false);
                        }
                    } else {
                         throw new Error("Error al verificar cuota.");
                    }

                } else {
                    throw new Error("Credenciales incorrectas");
                }
            } catch (error) {
                console.error(error);
                statusBox.className = "min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border px-2 py-1 bg-red-50 border-red-200";
                statusText.className = "text-xs font-bold text-red-600";
                statusText.innerText = error.message.includes("Credenciales") ? "Usuario o contraseña incorrectos" : "Error de conexión";
                
                btnText.classList.remove('hidden-text');
                loader.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function showAccessDeniedModal() {
            const modal = document.getElementById('access-denied-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0', 'scale-95');
                modal.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        function loginUserSuccess(name, usernameUnique, isAutoLogin) {
            currentUser = usernameUnique;
            document.getElementById('user-name-display').innerText = name; 
            
            const loginScreen = document.getElementById('login-screen');
            const loader = document.getElementById('initial-loader');
            const appContent = document.getElementById('app-content');

            loginScreen.classList.add('fade-out');
            setTimeout(() => loginScreen.classList.add('hidden'), 500);
            
            if(!isAutoLogin) {
                 loader.classList.add('hidden');
            } else {
                refreshQuota(usernameUnique);
            }

            appContent.classList.remove('hidden');
            setTimeout(() => {
                appContent.classList.remove('opacity-0');
                updateQuotaDisplay();
                initDropdowns(); 
                selectDays(selectedDays); 
            }, 100);
        }

        function logout() {
            sessionStorage.removeItem('pinceladas_session');
            location.reload();
        }

        async function refreshQuota(username) {
            try {
                const response = await fetch(`${API_AUTH_URL}?action=checkPlannerQuota&username=${encodeURIComponent(username)}`);
                const data = await response.json();
                if(data.success && !data.restricted) {
                    dailyQuota.remaining = data.remaining;
                    dailyQuota.total = data.limit;
                    updateQuotaDisplay();
                } else if (data.restricted) {
                    logout();
                }
            } catch(e) { console.error("Error refrescando cuota", e); }
        }

        function updateQuotaDisplay() {
            const counter = document.getElementById('usage-counter');
            if(dailyQuota.total > 0) {
                counter.innerText = `${dailyQuota.remaining} / ${dailyQuota.total}`;
                if(dailyQuota.remaining === 0) counter.className = "text-[10px] font-black text-red-600";
                else counter.className = "text-[10px] font-black text-montessori-blue";
            } else {
                counter.innerText = "...";
            }
        }

        // --- UTILIDADES ---
        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function selectDays(days) {
            selectedDays = days;
            document.getElementById('selectedDays').value = days;
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`day-${i}`);
                if (btn) {
                    if (i === days) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            }
        }

        // --- GESTIÓN DE PLANTILLA WORD ---
        function handleTemplateSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('template-name').textContent = file.name;
                showToast("Plantilla cargada exitosamente");
            }
        }

        // --- IMÁGENES ---
        async function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            if (attachedImages.length + files.length > MAX_IMAGES) {
                showToast(`Máximo ${MAX_IMAGES} imágenes permitidas.`);
                event.target.value = ""; 
                return;
            }

            const uploadArea = document.getElementById('upload-area');
            const originalText = uploadArea.innerHTML;
            uploadArea.innerHTML = '<span class="text-xs text-blue-500 font-bold animate-pulse">Procesando...</span>';

            try {
                const compressedPromises = files.map(file => compressImage(file, 800, 0.7));
                const newImages = await Promise.all(compressedPromises);
                attachedImages = [...attachedImages, ...newImages];
                renderImagePreviews();
            } catch (err) {
                showToast("Error al procesar alguna imagen.");
                console.error(err);
            } finally {
                uploadArea.innerHTML = originalText;
                document.getElementById('image-upload').value = ""; 
            }
        }

        function renderImagePreviews() {
            const grid = document.getElementById('images-grid');
            const uploadArea = document.getElementById('upload-area');
            const counter = document.getElementById('img-count');

            grid.innerHTML = ''; 

            if (attachedImages.length > 0) {
                grid.classList.remove('hidden');
                if (attachedImages.length >= MAX_IMAGES) {
                    uploadArea.classList.add('hidden');
                } else {
                    uploadArea.classList.remove('hidden');
                }

                attachedImages.forEach((base64, index) => {
                    const div = document.createElement('div');
                    div.className = "relative group rounded-lg overflow-hidden border border-gray-200 aspect-square";
                    div.innerHTML = `
                        <img src="${base64}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="removeImage(${index})" class="bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-sm transition-transform hover:scale-110">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            } else {
                grid.classList.add('hidden');
                uploadArea.classList.remove('hidden');
            }
            counter.innerText = `${attachedImages.length}/${MAX_IMAGES}`;
        }

        function removeImage(index) {
            attachedImages.splice(index, 1);
            renderImagePreviews();
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        // --- MODAL DE INSTRUCCIONES ---
        function toggleInstructionsModal() {
            const modal = document.getElementById('instructions-modal');
            modal.classList.toggle('hidden');
        }

        function saveInstructions() {
            const input = document.getElementById('instructions-input');
            const hiddenField = document.getElementById('customInstructions');
            const btn = document.getElementById('btn-instructions');
            const btnText = document.getElementById('btn-instructions-text');
            
            hiddenField.value = input.value.trim();
            toggleInstructionsModal();

            const hasText = hiddenField.value.length > 0;
            const imgCount = attachedImages.length;

            if (hasText || imgCount > 0) {
                btn.className = "w-full py-2.5 px-3 rounded-lg bg-montessori-red text-white border border-transparent shadow-md hover:bg-red-700 transition-all duration-300 flex items-center justify-center gap-2 group";
                if (hasText && imgCount > 0) btnText.textContent = `Instrucciones + ${imgCount} Fotos`;
                else if (imgCount > 0) btnText.textContent = `${imgCount} Fotos Adjuntadas`;
                else btnText.textContent = "Instrucciones Guardadas";
            } else {
                btn.className = "w-full py-2.5 px-3 rounded-lg bg-gray-50 border border-dashed border-gray-300 text-gray-600 hover:text-montessori-blue hover:border-montessori-blue hover:bg-blue-50 transition-all duration-300 flex items-center justify-center gap-2 group";
                btnText.textContent = "Añadir Instrucciones / Fotos";
            }
        }

        // --- DROPDOWNS ---
        function initDropdowns() {}
        function toggleDropdown(type) {
            const list = type === 'style' ? document.getElementById('style-dropdown-list') : null;
            const chevron = type === 'style' ? document.getElementById('style-chevron') : null;
            if (list) {
                list.classList.toggle('hidden');
                if(chevron) chevron.classList.toggle('rotate-180');
            }
        }
        function selectDropdownValue(type, value) {
            document.getElementById('teachingStyle').value = value;
            document.getElementById('selected-style-text').textContent = value;
            document.getElementById('style-dropdown-list').classList.add('hidden');
            document.getElementById('style-chevron').classList.remove('rotate-180');
        }

        document.addEventListener('click', function(e) {
            const styleBtn = document.getElementById('style-dropdown-btn');
            const styleList = document.getElementById('style-dropdown-list');
            if (styleList && !styleList.classList.contains('hidden') && !styleList.contains(e.target) && !styleBtn.contains(e.target)) {
                styleList.classList.add('hidden');
                document.getElementById('style-chevron').classList.remove('rotate-180');
            }
        });
        
        // --- HELPER DE REINTENTO ---
        async function fetchWithRetry(url, options, retries = 3, delay = 2000) {
            let lastError;
            let lastResponse;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    // Check HTTP status
                    if (response.status === 503 || response.status === 429) {
                        throw new Error("HTTP_OVERLOAD");
                    }

                    // Check API specific Logical error (Model Overloaded often comes as 200 OK in GAS proxies)
                    // We must clone because we consume the stream
                    const clone = response.clone();
                    try {
                        const data = await clone.json();
                        // Check for specific "overloaded" or "capacity" messages in the error field
                        if (data.success === false) {
                            const err = (data.error || "").toLowerCase();
                            if (err.includes("overloaded") || err.includes("capacity") || err.includes("too many requests")) {
                                throw new Error("LOGICAL_OVERLOAD");
                            }
                        }
                    } catch (jsonErr) {
                        // If it's not JSON, ignore and let main logic handle
                    }

                    return response; // Return valid response (success or non-retryable error)

                } catch (err) {
                    lastError = err;
                    // If it's the last retry, throw
                    if (i === retries - 1) throw err;

                    // Update UI
                    const loaderSubtitle = document.querySelector('#loader p');
                    if (loaderSubtitle) loaderSubtitle.innerText = `Servidores ocupados. Reintentando (${i+1}/${retries})...`;
                    
                    console.warn(`Retry ${i+1}/${retries} due to: ${err.message}`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 1.5; // Exponential backoff
                }
            }
            
            if (lastError) throw lastError;
            return lastResponse;
        }

        // --- GENERACIÓN DE PLAN (CORE LOGIC) ---
        async function generatePlan(e) {
            e.preventDefault();
            
            if (dailyQuota.remaining <= 0) {
                showToast("Has alcanzado tu límite diario.");
                return;
            }

            const subject = document.getElementById('subject').value;
            const groupDetails = document.getElementById('groupDetails').value;
            const style = document.getElementById('teachingStyle').value || "Por Competencias";
            const topics = document.getElementById('topics').value;
            const daysCount = parseInt(document.getElementById('selectedDays').value);
            const extraInstructions = document.getElementById('customInstructions').value;

            // Prompt diseñado para devolver JSON
            const systemInstruction = `
            Eres un planificador docente experto.
            Genera una planificación docente para ${daysCount} días.
            Asignatura: ${subject}
            Grupo: ${groupDetails}
            Tema(s): ${topics}
            Estilo: ${style}
            ${extraInstructions ? "Instrucciones Extra: " + extraInstructions : ""}
            ${attachedImages.length > 0 ? "Nota: Se adjuntaron imágenes de referencia, úsalas en la planificación si es relevante." : ""}

            IMPORTANTE: DEBES GENERAR LOS 5 DÍAS SOLICITADOS SI EL USUARIO LOS PIDE.
            Si el contenido es muy largo, REDUCE la longitud de las descripciones para asegurar que la respuesta completa (JSON cerrado) quepa en el límite de tokens. Prioriza completar la ESTRUCTURA de los 5 días sobre el detalle excesivo.

            REGLA PRINCIPAL DE TIEMPO: La suma de las actividades de INICIO, DESARROLLO y CIERRE debe ser de un total de 60 minutos (1 hora de clase).

            REGLAS DE ESTILO Y NOMENCLATURA:
            1. TEMAS PUNTUALES: El "tema" de cada día debe ser breve.
            2. TIEMPO AL INICIO: En cada actividad, pon el tiempo PRIMERO entre paréntesis. Ejemplo: "(10 min) Lluvia de ideas...".
            3. TEXTO DIRECTO: Describe las actividades de forma fluida.
            4. SIN TÍTULOS DE FANTASÍA.
            5. PREGUNTAS DIRECTAS.
            6. FORMATO JSON SEGURO: Dentro de los textos, usa comillas simples (') para evitar romper el JSON.

            IMPORTANTE: RESPONDE ÚNICAMENTE CON UN OBJETO JSON VÁLIDO.
            
            Estructura requerida:
            {
              "asignatura": "${subject}",
              "unidad": "Nombre formal de la unidad",
              "lunes": { "tema": "...", "inicio": "...", "desarrollo": "...", "cierre": "...", "tarea": "..." },
              "martes": { "tema": "...", "inicio": "...", "desarrollo": "...", "cierre": "...", "tarea": "..." },
              "miercoles": { "tema": "...", "inicio": "...", "desarrollo": "...", "cierre": "...", "tarea": "..." },
              "jueves": { "tema": "...", "inicio": "...", "desarrollo": "...", "cierre": "...", "tarea": "..." },
              "viernes": { "tema": "...", "inicio": "...", "desarrollo": "...", "cierre": "...", "tarea": "..." }
            }
            
            Si se piden menos de 5 días, deja las claves de los días no usados como cadenas vacías.
            `;

            const userPrompt = `Generar plan de ${daysCount} días para ${subject}.`;

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('result-placeholder').classList.add('hidden');
            document.getElementById('result-content').classList.add('hidden');
            document.getElementById('btn-generate').disabled = true;
            
            currentPlanData = null;

            try {
                const payload = { prompt: userPrompt, systemInstruction: systemInstruction };
                if (attachedImages.length > 0) payload.images = attachedImages;

                const response = await fetchWithRetry(API_GEN_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 503 || response.status === 429) {
                        throw new Error("Model overloaded");
                    }
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                if(!data.success) {
                    throw new Error(data.error || "Error desconocido.");
                }

                // LIMPIEZA Y PARSING ROBUSTO
                let cleanText = data.text;
                cleanText = cleanText.replace(/```json/gi, '').replace(/```/g, '').trim();
                
                const startIndex = cleanText.indexOf('{');
                if (startIndex === -1) throw new Error("No se encontró un bloque JSON válido.");
                
                // Intento 1: Extracción estricta (asumiendo que hay un cierre })
                const lastIndex = cleanText.lastIndexOf('}');
                let jsonCandidate = "";
                
                if (lastIndex > startIndex) {
                    jsonCandidate = cleanText.substring(startIndex, lastIndex + 1);
                } else {
                    // Si no hay cierre, tomamos todo hasta el final (truncado severo)
                    jsonCandidate = cleanText.substring(startIndex);
                }

                // Corrección de coma inicial
                jsonCandidate = jsonCandidate.replace(/\{\s*,/g, '{');

                try {
                    currentPlanData = JSON5.parse(jsonCandidate);
                } catch (e) {
                    // SI FALLA: Estrategia de Reparación por Truncamiento
                    console.warn("JSON inicial inválido, intentando reparar...", e.message);
                    
                    // Si falló el estricto, puede ser que el lastIndex fuera interno y no el final real (si estaba truncado).
                    // Probamos tomando TODO el texto restante y cerrando llaves.
                    let looseCandidate = cleanText.substring(startIndex);
                    let repaired = false;

                    // Intentamos cerrar hasta 5 llaves (ej: root -> lunes -> inicio)
                    let suffix = "";
                    for(let i=0; i<10; i++) { // Intentar cerrar brackets/llaves
                        suffix += "}";
                        try {
                            currentPlanData = JSON5.parse(looseCandidate + suffix);
                            repaired = true;
                            break;
                        } catch(err) {
                            // Si falla, probar cerrar comillas primero
                             try {
                                currentPlanData = JSON5.parse(looseCandidate + '"' + suffix);
                                repaired = true;
                                break;
                            } catch(err2) { /* continue */ }
                        }
                    }
                    
                    if (!repaired) {
                        // Último intento: Usar el candidato estricto original y tratar de cerrarlo
                        // (Por si había texto basura al final que confundió al looseCandidate)
                        suffix = "";
                        for(let i=0; i<5; i++) {
                            suffix += "}";
                            try {
                                currentPlanData = JSON5.parse(jsonCandidate + suffix);
                                repaired = true;
                                break;
                            } catch(err) {}
                        }
                    }

                    if (!repaired) throw new Error("La IA generó una respuesta incompleta que no se pudo reparar automáticamente.");
                }
                
                // Si llegamos aquí, currentPlanData tiene datos válidos (reparados o no)
                renderEditor(currentPlanData, daysCount);

                // Registrar uso
                fetch(API_AUTH_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({ action: 'registerPlannerUsage', username: currentUser })
                }).then(res => res.json()).then(regData => {
                     if(regData.success) {
                         dailyQuota.remaining = Math.max(0, dailyQuota.remaining - 1);
                         updateQuotaDisplay();
                     }
                });

                document.getElementById('loader').classList.add('hidden');
                const resCont = document.getElementById('result-content');
                resCont.classList.remove('hidden');
                resCont.classList.add('flex');
                requestAnimationFrame(() => resCont.classList.remove('translate-y-4', 'opacity-0'));
                
                const fileInput = document.getElementById('template-upload');
                if (fileInput.files.length > 0) {
                    document.getElementById('btn-download-word').classList.remove('hidden');
                }

            } catch (error) {
                console.error("ERROR:", error);
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('result-placeholder').classList.remove('hidden');
                
                const errorMsg = error.message ? error.message.toLowerCase() : "";
                if (errorMsg.includes("overloaded") || errorMsg.includes("capacity") || errorMsg.includes("503") || errorMsg.includes("429")) {
                    showToast("⚠️ Servidores saturados. Reintentando...");
                } else {
                    showToast("Error: " + error.message);
                }
            } finally {
                const loaderTitle = document.querySelector('#loader h3');
                const loaderSubtitle = document.querySelector('#loader p');
                if (loaderTitle) loaderTitle.innerText = "Analizando Recursos...";
                if (loaderSubtitle) loaderSubtitle.innerText = "Creando actividades personalizadas...";
                
                document.getElementById('btn-generate').disabled = false;
            }
        }

        // --- RENDERIZADO DEL EDITOR (TARJETAS) ---
        function renderEditor(data, daysCount) {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            const daysMap = [
                { key: 'lunes', label: 'Lunes' },
                { key: 'martes', label: 'Martes' },
                { key: 'miercoles', label: 'Miércoles' },
                { key: 'jueves', label: 'Jueves' },
                { key: 'viernes', label: 'Viernes' }
            ];

            for(let i = 0; i < daysCount; i++) {
                const dayInfo = daysMap[i];
                const dayData = data[dayInfo.key] || {};
                
                const card = document.createElement('div');
                card.className = 'plan-card';
                card.innerHTML = `
                    <h3 class="day-header">${dayInfo.label}</h3>
                    
                    <label class="section-label">Tema / Contenido</label>
                    <textarea id="topic_${dayInfo.key}" class="editable-field field-topic" placeholder="Tema del día...">${dayData.tema || ''}</textarea>
                    
                    <label class="section-label">1. INICIO (Secuencia Didáctica)</label>
                    <textarea id="inicio_${dayInfo.key}" class="editable-field" style="height: 5rem;" placeholder="Actividades de inicio (X min)...">${dayData.inicio || ''}</textarea>
                    
                    <label class="section-label">2. DESARROLLO (Secuencia Didáctica)</label>
                    <textarea id="desarrollo_${dayInfo.key}" class="editable-field" style="height: 8rem;" placeholder="Actividades clave del desarrollo...">${dayData.desarrollo || ''}</textarea>
                    
                    <label class="section-label">3. CIERRE (Secuencia Didáctica)</label>
                    <textarea id="cierre_${dayInfo.key}" class="editable-field" style="height: 5rem;" placeholder="Actividades de cierre y evaluación (X min)...">${dayData.cierre || ''}</textarea>

                    <label class="section-label">TAREA (Opcional)</label>
                    <textarea id="tarea_${dayInfo.key}" class="editable-field" style="height: 3rem;" placeholder="Tarea para casa o actividad extra...">${dayData.tarea || ''}</textarea>
                `;
                container.appendChild(card);
            }
        }

        // --- DESCARGA WORD ---
        // FIX FUNCIONAL: Lógica robusta para evitar errores si faltan campos
        function getValueOrEmpty(id) {
            const el = document.getElementById(id);
            if (el) {
                return el.value || ''; // Si existe pero es null/undefined, retorna ''
            }
            return ''; // Si no existe el elemento, retorna ''
        }

        function downloadWord() {
            const fileInput = document.getElementById('template-upload');
            if (fileInput.files.length === 0) {
                showToast("Sube tu plantilla .docx primero");
                return;
            }

            const safePlanData = currentPlanData || {};
            
            // Usamos getValueOrEmpty para garantizar que no haya nulls
            const finalData = {
                // Información general
                asignatura: getValueOrEmpty('subject'),
                unidad: safePlanData.unidad || "Unidad no definida",
                // Lunes
                tema_lunes: getValueOrEmpty('topic_lunes'),
                inicio_lunes: getValueOrEmpty('inicio_lunes'),
                desarrollo_lunes: getValueOrEmpty('desarrollo_lunes'),
                cierre_lunes: getValueOrEmpty('cierre_lunes'),
                tarea_lunes: getValueOrEmpty('tarea_lunes'),
                // Martes
                tema_martes: getValueOrEmpty('topic_martes'),
                inicio_martes: getValueOrEmpty('inicio_martes'),
                desarrollo_martes: getValueOrEmpty('desarrollo_martes'),
                cierre_martes: getValueOrEmpty('cierre_martes'),
                tarea_martes: getValueOrEmpty('tarea_martes'),
                // Miércoles
                tema_miercoles: getValueOrEmpty('topic_miercoles'),
                inicio_miercoles: getValueOrEmpty('inicio_miercoles'),
                desarrollo_miercoles: getValueOrEmpty('desarrollo_miercoles'),
                cierre_miercoles: getValueOrEmpty('cierre_miercoles'),
                tarea_miercoles: getValueOrEmpty('tarea_miercoles'),
                // Jueves
                tema_jueves: getValueOrEmpty('topic_jueves'),
                inicio_jueves: getValueOrEmpty('inicio_jueves'),
                desarrollo_jueves: getValueOrEmpty('desarrollo_jueves'),
                cierre_jueves: getValueOrEmpty('cierre_jueves'),
                tarea_jueves: getValueOrEmpty('tarea_jueves'),
                // Viernes
                tema_viernes: getValueOrEmpty('topic_viernes'),
                inicio_viernes: getValueOrEmpty('inicio_viernes'),
                desarrollo_viernes: getValueOrEmpty('desarrollo_viernes'),
                cierre_viernes: getValueOrEmpty('cierre_viernes'),
                tarea_viernes: getValueOrEmpty('tarea_viernes'),
            };

            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    if (typeof window.PizZip !== 'function') {
                         throw new Error("La librería PizZip no se ha cargado correctamente.");
                    }

                    const zip = new window.PizZip(evt.target.result);
                    const doc = new window.docxtemplater(zip, {
                        paragraphLoop: true,
                        linebreaks: true,
                        // nullGetter previene errores si algún dato se escapó como null
                        nullGetter: function(part) { return ""; }
                    });

                    doc.render(finalData);

                    const out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    });

                    saveAs(out, `Plan_${finalData.asignatura.replace(/\s+/g, '_')}_Semana.docx`);
                    showToast("¡Descarga iniciada!");

                } catch (error) {
                    console.error("Error DocxTemplater:", error);
                    if (error.properties && error.properties.errors) {
                        error.properties.errors.forEach(function(err) { console.log(err); });
                    }
                    showToast("Error al generar Word. Revisa tu plantilla.");
                }
            };
            reader.readAsBinaryString(fileInput.files[0]);
        }

    </script>
</body>
</html>
